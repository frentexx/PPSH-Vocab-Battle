--- START OF FILE index.html ---
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPSH Vocabulary Battle V6.1 | å±åŒ—å–®å­—æ˜Ÿéš›çˆ­éœ¸ä¿®æ­£ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: { bg: '#0B0F19', card: '#131B2E', cyan: '#06B6D4', purple: '#8B5CF6', orange: '#F97316', yellow: '#FACC15', green: '#22C55E', danger: '#EF4444', pink: '#EC4899' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0B0F19; color: #E2E8F0; font-family: 'Noto Sans TC', sans-serif; min-height: 100vh; overflow-x: hidden; user-select: none; }
        .glass-panel { background: rgba(19, 27, 46, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* ä¿®æ­£é®ç½©å±¤ï¼šç¢ºä¿é è¨­éš±è—ä¸”é»æ“Šä¸ç©¿é€ */
        .feedback-overlay { position: fixed; inset: 0; background: rgba(11, 15, 25, 0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .feedback-overlay.active { display: flex; animation: fadeIn 0.3s ease-out forwards; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* éŠæˆ²å…ƒç´  */
        .match-btn { transition: all 0.2s; cursor: pointer; }
        .match-btn:active { transform: scale(0.95); }
        .wrong-shake { animation: shake 0.4s ease-in-out; border-color: #EF4444 !important; background: rgba(239, 68, 68, 0.2) !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

        .letter-slot { width: 35px; height: 45px; border-bottom: 3px solid #334155; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 24px; font-weight: bold; color: #06B6D4; margin: 0 4px; }
        .letter-slot.filled { border-bottom-color: #06B6D4; color: #fff; animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        .balloon-item { position: absolute; cursor: pointer; z-index: 50; animation: balloonFall linear forwards; }
        @keyframes balloonFall { from { top: -100px; } to { top: 100vh; } }
    </style>
</head>
<body>

    <div id="app-container" class="max-w-md mx-auto min-h-screen relative flex flex-col z-10">
        
        <!-- HEADER -->
        <header id="app-header" class="hidden p-4 flex justify-between items-center glass-panel sticky top-0 z-50 rounded-b-2xl">
            <div class="flex flex-col leading-none">
                <span class="text-[10px] text-cyber-cyan tracking-widest font-display">PPSH GALAXY</span>
                <span id="nav-title" class="font-display font-bold text-lg text-white">BATTLE</span>
            </div>
            <div id="user-status" class="flex items-center gap-2">
                <div class="text-right">
                    <div class="text-[10px] text-gray-400">XP</div>
                    <span id="header-score" class="text-cyber-cyan font-bold font-mono text-lg">0</span>
                </div>
                <img id="header-avatar" src="" class="w-10 h-10 rounded-full border-2 border-cyber-purple bg-black">
            </div>
        </header>

        <!-- VIEWS -->
        <section id="view-login" class="flex-1 flex flex-col justify-center px-6">
            <div class="flex flex-col items-center mb-12">
                <div class="w-24 h-24 rounded-full bg-cyber-cyan/20 border-2 border-cyber-cyan flex items-center justify-center mb-6 shadow-[0_0_30px_#06B6D4]">
                    <i data-lucide="rocket" class="w-10 h-10 text-cyber-cyan"></i>
                </div>
                <h1 class="text-3xl font-bold text-center tracking-tight">å±åŒ—é«˜ä¸­<br><span class="text-cyber-cyan font-display uppercase text-xl">Vocab Battle</span></h1>
            </div>
            <button onclick="window.app.auth.login()" class="w-full py-4 rounded-xl bg-white text-black font-bold flex items-center justify-center gap-2">ç™»å…¥ Google å¸³è™Ÿ</button>
        </section>

        <section id="view-dashboard" class="hidden flex-1 flex flex-col p-4 gap-6">
            <div class="glass-panel p-5 rounded-2xl">
                <h2 id="dash-name" class="text-xl font-bold">è¼‰å…¥ä¸­...</h2>
                <p id="dash-team" class="text-xs text-gray-400 mt-1">ç„¡æ‰€å±¬æˆ°éšŠ</p>
            </div>

            <div class="space-y-4 overflow-y-auto pb-20">
                <div class="text-xs font-bold text-gray-500 uppercase tracking-widest">å€‹äººè¨“ç·´åŸºåœ°</div>
                <div class="grid grid-cols-2 gap-3">
                    <div onclick="window.app.game.setup('practice', 'match')" class="glass-panel p-4 rounded-xl border-l-4 border-cyber-green cursor-pointer"><i data-lucide="layers" class="text-cyber-green mb-2"></i><div class="font-bold text-sm">é…å°éŠæˆ²</div></div>
                    <div onclick="window.app.game.setup('practice', 'wheel')" class="glass-panel p-4 rounded-xl border-l-4 border-cyber-yellow cursor-pointer"><i data-lucide="refresh-cw" class="text-cyber-yellow mb-2"></i><div class="font-bold text-sm">å‘½é‹è¼ªç›¤</div></div>
                    <div onclick="window.app.game.setup('practice', 'standard')" class="glass-panel p-4 rounded-xl border-l-4 border-cyber-cyan cursor-pointer"><i data-lucide="volume-2" class="text-cyber-cyan mb-2"></i><div class="font-bold text-sm">è½éŸ³è¾¨ç¾©</div></div>
                    <div onclick="window.app.game.setup('practice', 'fill')" class="glass-panel p-4 rounded-xl border-l-4 border-cyber-orange cursor-pointer"><i data-lucide="pen-tool" class="text-cyber-orange mb-2"></i><div class="font-bold text-sm">çŸ­å¥å¡«ç©º</div></div>
                </div>
                <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mt-4">æˆ°éšŠç«¶æŠ€å ´</div>
                <div onclick="window.app.game.setup('ranked', 'wordpop')" class="glass-panel p-4 rounded-xl border border-cyber-pink/30 cursor-pointer flex justify-between items-center">
                    <div><h4 class="font-bold text-cyber-pink">ğŸ«§ å­—æ¯çˆ†ç ´ (Word Pop)</h4><p class="text-[10px] text-gray-400">è½éŸ³æ‹¼å­— â€¢ å­—æ¯çˆ†ç ´</p></div><i data-lucide="zap" class="text-cyber-pink"></i>
                </div>
            </div>
        </section>

        <section id="view-setup" class="hidden flex-1 flex flex-col p-6 justify-center">
            <div class="glass-panel p-6 rounded-2xl space-y-6">
                <h2 class="text-xl font-bold text-center">ä»»å‹™è¨­å®š</h2>
                <select id="setup-level" class="w-full bg-black/40 border border-white/10 rounded-lg p-3"></select>
                <input type="range" id="setup-count" min="5" max="20" step="5" value="10" class="w-full">
                <button onclick="window.app.game.start()" class="w-full py-4 bg-cyber-cyan text-black font-bold rounded-lg">é–‹å§‹ä½œæˆ°</button>
            </div>
        </section>

        <section id="view-game" class="hidden flex-1 flex flex-col relative overflow-hidden">
            <div class="p-4 flex justify-between items-center z-40">
                <button onclick="window.app.game.quit()" class="p-2 bg-white/5 rounded-full"><i data-lucide="x"></i></button>
                <div id="in-game-score" class="text-lg font-bold font-mono text-cyber-orange">0</div>
            </div>
            <div id="game-stage" class="flex-1 flex flex-col items-center justify-center p-4"></div>
        </section>

        <!-- RESULT & STUDY LIST -->
        <section id="view-result" class="hidden flex-1 flex flex-col p-6 items-center overflow-y-auto">
            <h2 class="text-3xl font-black mb-8">MISSION COMPLETE</h2>
            <div id="res-score" class="text-5xl font-bold text-cyber-cyan mb-8">0</div>
            <div class="w-full space-y-2" id="res-study-list"></div>
            <button onclick="window.app.nav.to('dashboard')" class="w-full py-4 mt-8 bg-white/10 rounded-xl">å›ä¸»é¸å–®</button>
        </section>

        <!-- FEEDBACK OVERLAY (ä¿®æ­£ï¼šç§»è‡³å¤–å±¤ä¸” z-index æœ€é«˜) -->
        <div id="game-feedback" class="feedback-overlay">
            <div id="fb-icon" class="mb-4"></div>
            <div id="fb-word" class="text-5xl font-bold text-white mb-2"></div>
            <div id="fb-chinese" class="text-2xl text-cyber-cyan mb-4"></div>
            <div id="fb-sentence" class="text-gray-400 italic px-8 max-w-sm"></div>
            <div class="mt-12 text-xs text-white/30 animate-pulse tracking-widest">AUTO-SCANNING...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQC4nD1ceknWbYq0DwY461XgPMSpzxzoE",
            authDomain: "ppsh-vocab-battle.firebaseapp.com",
            projectId: "ppsh-vocab-battle",
            storageBucket: "ppsh-vocab-battle.firebasestorage.app",
            messagingSenderId: "687928286974",
            appId: "1:687928286974:web:b79bd4476f63ce9d9bcfaf"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const googleProvider = new GoogleAuthProvider();

        let audioCtx;
        const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };

        window.app = {
            state: { user: null, words: [], quizList: [], currentIdx: 0, score: 0, mistakes: [], type: '' },

            init: () => {
                lucide.createIcons();
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        const snap = await getDoc(doc(db, "users", u.uid));
                        if (!snap.exists()) await setDoc(doc(db, "users", u.uid), { displayName: u.displayName, photoURL: u.photoURL, score: 0 });
                        app.state.user = { uid: u.uid, ...snap.data() };
                        app.ui.updateHeader();
                        app.nav.to('dashboard');
                        // é å…ˆè¼‰å…¥å–®å­—
                        const wSnap = await getDocs(collection(db, "words"));
                        app.state.words = wSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    } else {
                        app.nav.to('login');
                    }
                });
            },

            auth: { login: () => signInWithPopup(auth, googleProvider) },

            nav: {
                to: (id) => {
                    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                    document.getElementById('view-' + id).classList.remove('hidden');
                }
            },

            game: {
                setup: (mode, type) => {
                    if (app.state.words.length === 0) return alert("å–®å­—è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...");
                    app.state.type = type;
                    const levels = [...new Set(app.state.words.map(w => w.level))].sort();
                    const sel = document.getElementById('setup-level');
                    sel.innerHTML = '<option value="all">æ‰€æœ‰ç´šåˆ¥</option>';
                    levels.forEach(l => sel.innerHTML += `<option value="${l}">Level ${l}</option>`);
                    app.nav.to('setup');
                },

                start: () => {
                    initAudio();
                    const lvl = document.getElementById('setup-level').value;
                    const count = parseInt(document.getElementById('setup-count').value);
                    let pool = app.state.words.filter(w => lvl === 'all' || String(w.level) === lvl);
                    app.state.quizList = pool.sort(() => Math.random() - 0.5).slice(0, count);
                    app.state.currentIdx = 0; app.state.score = 0; app.state.mistakes = [];
                    app.nav.to('game');
                    app.game.next();
                },

                next: () => {
                    if (app.state.currentIdx >= app.state.quizList.length) return app.game.finish();
                    document.getElementById('in-game-score').innerText = app.state.score;
                    const q = app.state.quizList[app.state.currentIdx];
                    const stage = document.getElementById('game-stage');
                    stage.innerHTML = ''; // æ¸…ç©ºèˆå°

                    switch(app.state.type) {
                        case 'match': app.game.modes.match(q); break;
                        case 'wheel': app.game.modes.wheel(q); break;
                        case 'standard': app.game.modes.standard(q); break;
                        case 'wordpop': app.game.modes.wordpop(q); break;
                        case 'fill': app.game.modes.fill(q); break;
                    }
                    lucide.createIcons();
                },

                showFeedback: (isCorrect, callback) => {
                    const q = app.state.quizList[app.state.currentIdx];
                    const overlay = document.getElementById('game-feedback');
                    
                    document.getElementById('fb-icon').innerHTML = isCorrect ? 'âœ…' : 'âŒ';
                    document.getElementById('fb-word').innerText = q.word;
                    document.getElementById('fb-chinese').innerText = q.chinese;
                    document.getElementById('fb-sentence').innerText = q.sentence || '';
                    
                    overlay.classList.add('active');
                    app.audio.speak(q.word);

                    if (!isCorrect) app.state.mistakes.push(q);

                    setTimeout(() => {
                        overlay.classList.remove('active');
                        callback();
                    }, 3000);
                },

                modes: {
                    standard: (q) => {
                        const stage = document.getElementById('game-stage');
                        stage.innerHTML = `<button id="play-btn" class="w-20 h-20 bg-cyber-cyan/20 rounded-full mb-8"><i data-lucide="volume-2"></i></button><div class="grid grid-cols-2 gap-3 w-full" id="opts"></div>`;
                        document.getElementById('play-btn').onclick = () => app.audio.speak(q.word);
                        app.audio.speak(q.word);
                        app.game.utils.getOptions(q, 4).forEach(o => {
                            const b = document.createElement('button');
                            b.className = "p-4 glass-panel rounded-xl font-bold";
                            b.innerText = o.chinese;
                            b.onclick = () => app.game.showFeedback(o.id === q.id, () => { if(o.id===q.id) app.state.score+=10; app.state.currentIdx++; app.game.next(); });
                            document.getElementById('opts').appendChild(b);
                        });
                    },
                    match: () => {
                        const batch = app.state.quizList.slice(app.state.currentIdx, app.state.currentIdx + 4);
                        const stage = document.getElementById('game-stage');
                        let left = [...batch].sort(() => Math.random() - 0.5), right = [...batch].sort(() => Math.random() - 0.5);
                        let sel = null;
                        stage.innerHTML = `<div class="grid grid-cols-2 gap-4 w-full" id="match-grid"></div>`;
                        const render = () => {
                            const grid = document.getElementById('match-grid'); grid.innerHTML = '';
                            left.concat(right).forEach(w => {
                                if (w.done) return;
                                const b = document.createElement('button');
                                b.className = `p-4 glass-panel rounded-xl text-xs match-btn ${sel?.el === b ? 'border-white' : ''}`;
                                b.innerText = left.includes(w) ? w.word : w.chinese;
                                b.onclick = () => {
                                    app.audio.speak(w.word);
                                    if (!sel) { sel = { w, el: b }; render(); }
                                    else {
                                        if (sel.w.id === w.id && sel.el !== b) {
                                            app.audio.playTone(880, 0.2); w.done = true; app.state.score += 10;
                                            if (batch.every(i => i.done)) { app.state.currentIdx += 4; app.game.next(); } else render();
                                        } else {
                                            app.audio.playTone(150, 0.4); b.classList.add('wrong-shake'); setTimeout(() => render(), 400);
                                        }
                                        sel = null;
                                    }
                                };
                                grid.appendChild(b);
                            });
                        };
                        render();
                    },
                    wheel: (q) => {
                        const stage = document.getElementById('game-stage');
                        stage.innerHTML = `<div id="wheel" class="w-48 h-48 rounded-full border-4 border-cyber-yellow flex items-center justify-center text-2xl font-bold mb-8 transition-transform duration-[2s]">?</div><button id="spin" class="px-8 py-3 bg-cyber-yellow text-black font-bold rounded-full">SPIN</button>`;
                        document.getElementById('spin').onclick = () => {
                            const w = document.getElementById('wheel');
                            w.style.transform = `rotate(${1440 + Math.random() * 360}deg)`;
                            setTimeout(() => {
                                w.innerText = q.word; app.audio.speak(q.word);
                                app.game.showFeedback(true, () => { app.state.currentIdx++; app.game.next(); });
                            }, 2100);
                        };
                    },
                    wordpop: (q) => {
                        const stage = document.getElementById('game-stage');
                        let idx = 0;
                        stage.innerHTML = `<div class="text-xl font-bold text-cyber-pink mb-4">${q.chinese}</div><div class="flex mb-8" id="slots">${q.word.split('').map((_, i) => `<div id="s-${i}" class="letter-slot"></div>`).join('')}</div><div class="flex flex-wrap justify-center gap-2" id="bubs"></div>`;
                        q.word.split('').sort(() => Math.random() - 0.5).forEach((c, i) => {
                            const b = document.createElement('button');
                            b.className = "w-12 h-12 glass-panel rounded-full font-bold text-xl";
                            b.innerText = c;
                            b.onclick = () => {
                                if (c.toLowerCase() === q.word[idx].toLowerCase()) {
                                    document.getElementById('s-'+idx).innerText = q.word[idx];
                                    document.getElementById('s-'+idx).classList.add('filled');
                                    b.classList.add('invisible'); idx++;
                                    if(idx === q.word.length) app.game.showFeedback(true, () => { app.state.score += 20; app.state.currentIdx++; app.game.next(); });
                                } else {
                                    app.audio.playTone(150, 0.4); b.classList.add('wrong-shake'); setTimeout(() => b.classList.remove('wrong-shake'), 400);
                                }
                            };
                            document.getElementById('bubs').appendChild(b);
                        });
                    },
                    fill: (q) => {
                        const stage = document.getElementById('game-stage');
                        const s = (q.sentence || "The word is _____.").replace(new RegExp(q.word, 'gi'), '_____');
                        stage.innerHTML = `<div class="text-lg text-center mb-6">${s}</div><div class="grid grid-cols-2 gap-3 w-full" id="opts"></div><button id="skip" class="mt-8 text-xs underline">è·³éæ­¤é¡Œ</button>`;
                        app.game.utils.getOptions(q, 4).forEach(o => {
                            const b = document.createElement('button'); b.className="p-4 glass-panel rounded-xl"; b.innerText=o.word;
                            b.onclick = () => { if(o.id===q.id) app.game.showFeedback(true, ()=>{ app.state.score+=20; app.state.currentIdx++; app.game.next(); }); else { app.audio.playTone(150, 0.4); b.classList.add('wrong-shake'); setTimeout(() => b.classList.remove('wrong-shake'), 400); } };
                            document.getElementById('opts').appendChild(b);
                        });
                        document.getElementById('skip').onclick = () => app.game.showFeedback(false, () => { app.state.currentIdx++; app.game.next(); });
                    }
                },

                utils: {
                    getOptions: (q, count) => {
                        let res = [q];
                        let pool = app.state.words.filter(w => w.id !== q.id);
                        while(res.length < count && pool.length > 0) res.push(pool.splice(Math.floor(Math.random()*pool.length), 1)[0]);
                        return res.sort(() => Math.random() - 0.5);
                    }
                },

                finish: () => {
                    app.nav.to('result');
                    document.getElementById('res-score').innerText = app.state.score;
                    const list = document.getElementById('res-study-list'); list.innerHTML = '';
                    app.state.mistakes.forEach(m => {
                        list.innerHTML += `<div class="p-3 glass-panel rounded-xl flex justify-between"><div><div class="font-bold">${m.word}</div><div class="text-xs text-gray-400">${m.chinese}</div></div><button onclick="window.app.audio.speak('${m.word}')">ğŸ”Š</button></div>`;
                    });
                    if (app.state.user) updateDoc(doc(db, "users", app.state.user.uid), { score: increment(app.state.score) });
                }
            },

            audio: {
                speak: (t) => { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.lang = 'en-US'; window.speechSynthesis.speak(u); },
                playTone: (freq, dur) => {
                    if (!audioCtx) return;
                    const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    osc.type = 'sine'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
                    osc.connect(g); g.connect(audioCtx.destination);
                    osc.start(); osc.stop(audioCtx.currentTime + dur);
                }
            },

            ui: {
                updateHeader: () => {
                    document.getElementById('header-avatar').src = app.state.user.photoURL;
                    document.getElementById('header-score').innerText = app.state.user.score;
                    document.getElementById('dash-name').innerText = app.state.user.displayName;
                    document.getElementById('app-header').classList.remove('hidden');
                }
            }
        };

        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>