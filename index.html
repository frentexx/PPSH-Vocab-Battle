<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±åŒ—é«˜ä¸­å–®å­—æ˜Ÿéš›çˆ­éœ¸ | PPSH Vocab Galaxy</title>
    
    <!-- ç¨‹å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Zen+Maru+Gothic:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <!-- Tailwind è¨­å®š -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: { bg: '#0F172A', cyan: '#06B6D4', purple: '#8B5CF6', orange: '#FB923C', glass: 'rgba(30, 41, 59, 0.8)' }
                    },
                    fontFamily: { display: ['Orbitron', 'sans-serif'], body: ['Zen Maru Gothic', 'Noto Sans TC', 'sans-serif'] },
                    animation: { 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'spin-slow': 'spin 3s linear infinite' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0F172A; color: white; font-family: 'Zen Maru Gothic', sans-serif; min-height: 100vh; overflow-x: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2); }
        .neon-text { text-shadow: 0 0 10px rgba(6, 182, 212, 0.8), 0 0 20px rgba(139, 92, 246, 0.5); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* è·‘é¦¬ç‡ˆç‰¹æ•ˆ */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* ç¿»ç‰ŒéŠæˆ² */
        .card-flip { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; }
        .card-front { background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: transparent; }
        .card-back { background-color: #8B5CF6; color: white; transform: rotateY(180deg); border: 1px solid #A78BFA; }

        /* æ°£çƒ */
        .balloon { position: absolute; cursor: pointer; user-select: none; transition: transform 0.1s; }
        .balloon:active { transform: scale(0.95); }
    </style>
</head>
<body class="selection:bg-cyber-cyan selection:text-black">

    <canvas id="bgCanvas" class="fixed top-0 left-0 w-full h-full -z-10 opacity-30"></canvas>

    <div id="app-container" class="max-w-md mx-auto min-h-screen relative flex flex-col">
        
        <!-- HEADER (ç™»å…¥å¾Œé¡¯ç¤º) -->
        <header id="app-header" class="hidden p-4 flex justify-between items-center glass-panel sticky top-0 z-50 rounded-b-2xl mb-4">
            <div class="flex items-center gap-2">
                <i data-lucide="zap" class="text-cyber-orange w-6 h-6"></i>
                <h1 class="font-display font-bold text-lg tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-cyber-cyan to-cyber-purple">PPSH GALAXY</h1>
            </div>
            <div id="user-status" class="flex items-center gap-2">
                <span id="header-score" class="text-cyber-cyan font-bold font-mono">0</span>
                <img id="header-avatar" src="" class="w-8 h-8 rounded-full border border-cyber-purple bg-black object-cover">
            </div>
        </header>

        <!-- VIEW 1: å…¨æ–°ç™»å…¥é é¢ -->
        <section id="view-login" class="flex-1 flex flex-col relative overflow-hidden">
            <!-- Hero Section -->
            <div class="flex-1 flex flex-col items-center justify-center p-6 text-center z-10">
                <div class="mb-6 relative">
                    <div class="absolute inset-0 bg-cyber-cyan blur-[50px] opacity-20 rounded-full"></div>
                    <!-- æ ¡å¾½æˆ– Logo ä½”ä½ -->
                    <div class="w-24 h-24 rounded-full bg-gradient-to-tr from-blue-900 to-slate-900 border-2 border-cyber-cyan flex items-center justify-center mb-4 shadow-[0_0_20px_rgba(6,182,212,0.5)]">
                        <span class="text-3xl">ğŸš€</span>
                    </div>
                </div>
                <h1 class="text-4xl font-display font-black text-transparent bg-clip-text bg-gradient-to-r from-cyber-cyan via-white to-cyber-purple neon-text mb-2">
                    å±åŒ—é«˜ä¸­<br>å–®å­—æ˜Ÿéš›çˆ­éœ¸
                </h1>
                <p class="text-gray-300 text-sm tracking-widest mb-8 border-b border-cyber-cyan pb-2">PPSH VOCABULARY BATTLE</p>

                <!-- äº’å‹•æ’è¡Œæ¦œé è¦½ -->
                <div class="w-full grid grid-cols-2 gap-4 mb-8">
                    <!-- å€‹äººæ¦œ -->
                    <div class="glass-panel p-3 rounded-xl flex flex-col items-center">
                        <h3 class="text-cyber-cyan font-bold text-sm mb-2">æœ€å¼·å–®å­—ç‹</h3>
                        <div id="login-lb-user" class="w-full space-y-2 text-xs">
                            <div class="text-center text-gray-500 py-2">è®€å–ä¸­...</div>
                        </div>
                    </div>
                    <!-- åœ˜é«”æ¦œ -->
                    <div class="glass-panel p-3 rounded-xl flex flex-col items-center">
                        <h3 class="text-cyber-purple font-bold text-sm mb-2">æœ€å¼·æˆ°éšŠ</h3>
                        <div id="login-lb-team" class="w-full space-y-2 text-xs">
                            <div class="text-center text-gray-500 py-2">è®€å–ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- ç™»å…¥æŒ‰éˆ• -->
                <button onclick="window.app.auth.login()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-cyber-purple rounded-xl font-bold text-lg shadow-[0_0_20px_rgba(6,182,212,0.6)] hover:scale-105 transition-transform flex items-center justify-center gap-2">
                    <i data-lucide="log-in"></i> ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                </button>
                <p class="text-[10px] text-gray-500 mt-2">åƒ…é™ @ppsh.ptc.edu.tw ç¶²åŸŸä½¿ç”¨</p>
            </div>

            <!-- åº•éƒ¨è·‘é¦¬ç‡ˆ -->
            <div class="bg-black/50 border-t border-white/10 py-2 absolute bottom-0 w-full z-20">
                <div class="marquee-container">
                    <div id="ticker-content" class="marquee-content text-xs text-cyber-cyan font-mono">
                        ğŸš€ ç³»çµ±å…¬å‘Šï¼šæ­¡è¿ä¾†åˆ°å±åŒ—å–®å­—å®‡å®™... ğŸŒŸ 205ç­ å°æ˜ å‰›å‰›ç²å¾—äº† 500 åˆ†ï¼ ğŸ›¡ï¸ å±åŒ—æˆ°éšŠ é€£å‹ 10 å ´ï¼
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW 2: Dashboard (èˆ‡ä¹‹å‰ç›¸åŒï¼Œä¿ç•™åŠŸèƒ½) -->
        <section id="view-dashboard" class="hidden flex-1 flex flex-col p-4 gap-6">
            <div class="glass-panel rounded-2xl p-5 relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 id="dash-name" class="text-xl font-bold">åŒå­¸</h2>
                        <p id="dash-team" class="text-sm text-gray-400 mt-1">å°šæœªåŠ å…¥éšŠä¼</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-display font-bold text-cyber-orange" id="dash-total-score">0</div>
                        <div class="text-[10px] text-gray-500">CREDITS</div>
                    </div>
                </div>
                <div id="team-action-area" class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-2 gap-3">
                    <button onclick="window.app.team.create()" class="py-2 bg-white/5 rounded text-sm text-cyber-cyan border border-cyber-cyan/30">å»ºç«‹éšŠä¼</button>
                    <button onclick="window.app.team.join()" class="py-2 bg-white/5 rounded text-sm text-cyber-purple border border-cyber-purple/30">åŠ å…¥éšŠä¼</button>
                </div>
                <div id="team-status-area" class="hidden mt-4 pt-4 border-t border-gray-700">
                    <div class="text-xs text-gray-400 mb-2">éšŠä¼ç¢¼: <span id="team-code-display" class="text-white font-mono font-bold select-all"></span></div>
                    <div id="team-members-list" class="flex -space-x-2"></div>
                </div>
            </div>

            <div class="space-y-4 pb-20">
                <h3 class="font-display text-cyber-cyan text-sm tracking-widest border-b border-gray-700 pb-2">å€‹äººæŒ‘æˆ°å€ (SOLO)</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div onclick="window.app.game.setup('practice', 'match')" class="glass-panel p-3 rounded-xl hover:bg-white/10 cursor-pointer border-l-2 border-green-400">
                        <i data-lucide="link" class="mb-2 text-green-400"></i>
                        <h4 class="font-bold text-sm">é…å°éŠæˆ²</h4>
                        <p class="text-[10px] text-gray-400">Match</p>
                    </div>
                    <div onclick="window.app.game.setup('practice', 'wheel')" class="glass-panel p-3 rounded-xl hover:bg-white/10 cursor-pointer border-l-2 border-yellow-400">
                        <i data-lucide="aperture" class="mb-2 text-yellow-400"></i>
                        <h4 class="font-bold text-sm">å‘½é‹è¼ªç›¤</h4>
                        <p class="text-[10px] text-gray-400">Wheel</p>
                    </div>
                    <div onclick="window.app.game.setup('practice', 'audio')" class="glass-panel p-3 rounded-xl hover:bg-white/10 cursor-pointer border-l-2 border-blue-400 col-span-2">
                        <div class="flex items-center gap-3">
                            <i data-lucide="headphones" class="text-blue-400"></i>
                            <div>
                                <h4 class="font-bold text-sm">è½éŸ³è¾¨ç¾© (æ¨™æº–)</h4>
                                <p class="text-[10px] text-gray-400">Audio Quiz</p>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 class="font-display text-cyber-purple text-sm tracking-widest border-b border-gray-700 pb-2">åœ˜é«”ç«¶æŠ€å€ (TEAM)</h3>
                <div class="grid grid-cols-1 gap-3">
                    <div onclick="window.app.game.setup('ranked', 'speed')" class="glass-panel p-3 rounded-xl hover:bg-white/10 cursor-pointer border-l-4 border-red-500 flex justify-between items-center group">
                        <div>
                            <h4 class="font-bold text-red-400 group-hover:text-red-300">ğŸˆ ç–¾é€Ÿç ´å†° (Speed Pop)</h4>
                            <p class="text-[10px] text-gray-400">æ°£çƒæ‰è½ â€¢ åæ‡‰æ¥µé™</p>
                        </div>
                        <i data-lucide="zap" class="text-red-500"></i>
                    </div>
                    <div onclick="window.app.game.setup('ranked', 'memory')" class="glass-panel p-3 rounded-xl hover:bg-white/10 cursor-pointer border-l-4 border-purple-500 flex justify-between items-center group">
                        <div>
                            <h4 class="font-bold text-purple-400 group-hover:text-purple-300">ğŸ´ è¨˜æ†¶é…å° (Memory)</h4>
                            <p class="text-[10px] text-gray-400">ç¿»ç‰Œè¨˜æ†¶ â€¢ åœ˜éšŠåˆä½œ</p>
                        </div>
                        <i data-lucide="grid" class="text-purple-500"></i>
                    </div>
                </div>

                <div onclick="window.app.leaderboard.show()" class="glass-panel p-3 rounded-xl border border-cyber-cyan/30 text-center cursor-pointer hover:bg-cyber-cyan/10">
                    <span class="text-sm font-bold text-cyber-cyan"><i data-lucide="bar-chart-2" class="inline w-4 h-4 mr-1"></i> é€²å…¥æˆ°æƒ…ä¸­å¿ƒ</span>
                </div>
            </div>

            <button id="admin-btn" onclick="window.app.nav.to('admin')" class="hidden fixed bottom-4 right-4 bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white shadow-lg border border-gray-600 z-50">
                <i data-lucide="settings"></i>
            </button>
        </section>

        <!-- VIEW: Game Container -->
        <section id="view-game" class="hidden flex-1 flex flex-col relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full p-4 z-20 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent">
                <button onclick="window.app.nav.to('dashboard')" class="text-white bg-white/10 p-2 rounded-full"><i data-lucide="arrow-left"></i></button>
                <div class="flex flex-col items-center">
                    <span id="game-type-label" class="text-[10px] text-cyber-cyan uppercase tracking-widest">MODE</span>
                    <div class="w-32 h-1 bg-gray-800 rounded-full mt-1 overflow-hidden">
                        <div id="game-progress" class="h-full bg-cyber-cyan w-0 transition-all duration-300"></div>
                    </div>
                </div>
                <div class="text-xl font-bold font-mono text-cyber-orange" id="in-game-score">0</div>
            </div>
            <div id="game-stage" class="flex-1 w-full h-full relative flex flex-col items-center justify-center p-4 pt-20"></div>
        </section>

        <!-- VIEW: Setup -->
        <section id="view-setup" class="hidden flex-1 flex flex-col p-4 gap-6 justify-center">
            <h2 class="text-2xl font-bold text-center">è¨­å®šæŒ‘æˆ°</h2>
            <div class="glass-panel p-6 rounded-2xl space-y-6">
                <select id="setup-level" class="w-full bg-slate-800 border border-gray-600 rounded p-3"><option value="all">å…¨å®‡å®™ (All)</option><option value="1">L1</option><option value="2">L2</option><option value="3">L3</option><option value="4">L4</option><option value="5">L5</option><option value="6">L6</option></select>
                <div id="setup-count-group"><label class="block text-xs text-gray-400">é¡Œæ•¸: <span id="count-val">10</span></label><input type="range" id="setup-count" min="5" max="50" step="5" value="10" class="w-full"></div>
                <button onclick="window.app.game.start()" class="w-full py-3 bg-cyber-cyan text-black font-bold rounded">é–‹å§‹</button>
                <button onclick="window.app.nav.to('dashboard')" class="w-full py-2 text-gray-400 text-sm">å–æ¶ˆ</button>
            </div>
        </section>

        <!-- VIEW: Result -->
        <section id="view-result" class="hidden flex-1 flex flex-col p-6 items-center justify-center gap-6">
            <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyber-cyan to-cyber-purple">ä»»å‹™å®Œæˆ</h2>
            <div class="glass-panel w-full p-6 rounded-2xl text-center space-y-4">
                <div class="text-6xl font-display font-bold text-cyber-cyan" id="res-score">0</div>
                <div class="grid grid-cols-2 gap-4 mt-4"><button onclick="window.app.nav.to('dashboard')" class="py-3 bg-white/10 rounded">å›é¦–é </button><button onclick="window.app.game.setup(window.app.state.mode, window.app.state.gameType)" class="py-3 bg-cyber-purple rounded">å†ç©ä¸€æ¬¡</button></div>
            </div>
        </section>

        <!-- VIEW: Leaderboard -->
        <section id="view-leaderboard" class="hidden flex-1 flex flex-col p-4 gap-4">
             <div class="flex justify-between items-center"><h2 class="text-xl font-bold">æˆ°æƒ…ä¸­å¿ƒ</h2><button onclick="window.app.nav.to('dashboard')"><i data-lucide="x"></i></button></div>
             <div class="glass-panel p-2 rounded-xl flex gap-2"><button id="subtab-user" onclick="window.app.leaderboard.switchSubTab('user')" class="flex-1 py-2 rounded text-xs font-bold tab-active">å€‹äºº</button><button id="subtab-team" onclick="window.app.leaderboard.switchSubTab('team')" class="flex-1 py-2 rounded text-xs font-bold text-gray-400">åœ˜éšŠ</button></div>
             <div id="lb-detail-content" class="flex-1 overflow-y-auto space-y-2"></div>
        </section>

        <!-- VIEW: Admin -->
        <section id="view-admin" class="hidden flex-1 flex flex-col p-4 gap-4">
            <h2 class="text-xl font-bold text-cyber-orange">ç®¡ç†å“¡æ§åˆ¶å°</h2>
            <div class="glass-panel p-4 rounded-xl space-y-4">
                <input type="file" id="csv-upload" accept=".csv" class="block w-full text-xs text-gray-400 file:bg-cyber-purple file:text-white"/>
                <button onclick="window.app.admin.uploadCSV()" class="w-full py-2 bg-blue-600 rounded text-sm font-bold">åŒ¯å…¥ CSV</button>
                <button onclick="window.app.admin.hardReset()" class="w-full py-3 bg-red-600 text-white font-bold rounded text-sm mt-2">âš ï¸ ç³»çµ±ç¡¬é‡ç½®</button>
                <button onclick="window.app.nav.to('dashboard')" class="w-full py-2 bg-gray-700 rounded text-sm">é›¢é–‹</button>
            </div>
        </section>

    </div>

    <!-- Alert Box -->
    <div id="alert-box" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 hidden">
        <div class="glass-panel p-6 rounded-2xl max-w-xs w-full text-center border border-cyber-cyan/50">
            <h3 id="alert-title" class="text-xl font-bold mb-2 text-cyber-cyan">è¨Šæ¯</h3>
            <p id="alert-msg" class="text-gray-300 text-sm mb-4"></p>
            <button onclick="document.getElementById('alert-box').classList.add('hidden')" class="px-6 py-2 bg-cyber-cyan text-black font-bold rounded w-full">ç¢ºèª</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, query, where, getDocs, onSnapshot, limit, orderBy, increment, serverTimestamp, writeBatch, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQC4nD1ceknWbYq0DwY461XgPMSpzxzoE",
            authDomain: "ppsh-vocab-battle.firebaseapp.com",
            projectId: "ppsh-vocab-battle",
            storageBucket: "ppsh-vocab-battle.firebasestorage.app",
            messagingSenderId: "687928286974",
            appId: "1:687928286974:web:b79bd4476f63ce9d9bcfaf",
            measurementId: "G-675CNBRSZS"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const googleProvider = new GoogleAuthProvider();
        lucide.createIcons();

        // ----------------------------------------------------
        // Cultural Icons (SVG Definitions)
        // 1. Lily (White petals, red center)
        // 2. Clay Pot (Dark, ancient style)
        // 3. Snake (Black and white geometric/triangle pattern)
        // ----------------------------------------------------
        const CULTURAL_ICONS = {
            lily: `<svg viewBox="0 0 100 100" class="w-6 h-6 inline-block drop-shadow-md"><path d="M50 20 C60 5 80 20 50 50 C20 20 40 5 50 20 Z" fill="#fff" /><path d="M50 80 C40 95 20 80 50 50 C80 80 60 95 50 80 Z" fill="#fff" /><path d="M20 50 C5 40 20 20 50 50 C20 80 5 60 20 50 Z" fill="#fff" /><path d="M80 50 C95 60 80 80 50 50 C80 20 95 40 80 50 Z" fill="#fff" /><circle cx="50" cy="50" r="8" fill="#FF4500" /></svg>`,
            
            pot: `<svg viewBox="0 0 100 100" class="w-6 h-6 inline-block drop-shadow-md"><path d="M30 30 Q50 90 70 30 L60 20 L40 20 Z" fill="#5D4037" stroke="#3E2723" stroke-width="2"/><circle cx="50" cy="40" r="10" fill="none" stroke="#222" stroke-dasharray="2,2"/></svg>`,
            
            snake: `<svg viewBox="0 0 100 100" class="w-6 h-6 inline-block drop-shadow-md"><path d="M20 50 L35 30 L50 50 L65 30 L80 50 L65 70 L50 50 L35 70 Z" fill="#fff" stroke="black" stroke-width="2"/><rect x="10" y="45" width="80" height="10" fill="black" style="mix-blend-mode: overlay;"/></svg>`
        };

        const appLogic = {
            state: { user: null, team: null, words: [], quizList: [], currentQIndex: 0, score: 0, mode: 'practice', gameType: 'audio', lbSubTab: 'user' },
            
            init: () => {
                appLogic.ui.bgAnimation();
                appLogic.ui.startTicker();
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        if (!user.email.endsWith("@ppsh.ptc.edu.tw")) { appLogic.ui.alert("å­˜å–è¢«æ‹’", "åƒ…é™ @ppsh.ptc.edu.tw"); await signOut(auth); return; }
                        if (["fuwen@ppsh.ptc.edu.tw"].includes(user.email)) document.getElementById('admin-btn').classList.remove('hidden');
                        
                        const userRef = doc(db, "users", user.uid);
                        const userSnap = await getDoc(userRef);
                        if (!userSnap.exists()) {
                            await setDoc(userRef, { email: user.email, displayName: user.displayName, photoURL: user.photoURL, score: 0, weeklyScore: 0, teamId: null, lastPlayed: serverTimestamp() });
                            appLogic.state.user = { uid: user.uid, score: 0, teamId: null, ...user };
                        } else {
                            appLogic.state.user = { uid: user.uid, ...userSnap.data() };
                        }
                        if (appLogic.state.user.teamId) appLogic.team.load(appLogic.state.user.teamId);
                        appLogic.ui.updateHeader();
                        appLogic.nav.to('dashboard');
                    } else {
                        appLogic.nav.to('login');
                        appLogic.leaderboard.renderPreview();
                    }
                });
            },
            auth: { login: () => signInWithPopup(auth, googleProvider).catch(e => appLogic.ui.alert("éŒ¯èª¤", e.message)) },
            
            game: {
                setup: async (mode, type) => {
                    appLogic.state.mode = mode;
                    appLogic.state.gameType = type;
                    
                    if (appLogic.state.words.length === 0) {
                        const q = query(collection(db, "words"), limit(500));
                        const snapshot = await getDocs(q);
                        appLogic.state.words = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (appLogic.state.words.length === 0) { appLogic.ui.alert("æç¤º", "ç„¡å–®å­—è³‡æ–™"); return; }
                    }
                    document.getElementById('setup-count-group').style.display = mode === 'ranked' ? 'none' : 'block';
                    appLogic.nav.to('setup');
                },

                start: () => {
                    const level = document.getElementById('setup-level').value;
                    const count = appLogic.state.mode === 'ranked' ? 20 : parseInt(document.getElementById('setup-count').value);
                    
                    let pool = appLogic.state.words.filter(w => {
                        if (level === 'all') return true;
                        if (level.includes('-')) { const [min, max] = level.split('-').map(Number); return parseInt(w.level) >= min && parseInt(w.level) <= max; }
                        return w.level === level;
                    });
                    if (pool.length < 5) pool = appLogic.state.words;
                    pool.sort(() => Math.random() - 0.5);
                    appLogic.state.quizList = pool.slice(0, count);
                    appLogic.state.currentQIndex = 0; 
                    appLogic.state.score = 0; 

                    appLogic.nav.to('game');
                    document.getElementById('game-type-label').innerText = appLogic.state.gameType;
                    
                    if (appLogic.state.gameType === 'match') appLogic.game.startMatchGame();
                    else if (appLogic.state.gameType === 'wheel') appLogic.game.startWheelGame();
                    else if (appLogic.state.gameType === 'speed') appLogic.game.startSpeedGame();
                    else if (appLogic.state.gameType === 'memory') appLogic.game.startMemoryGame();
                    else appLogic.game.nextStandard(); 
                },

                // 1. Standard/Audio
                nextStandard: () => {
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finish(); return; }
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    appLogic.ui.updateGameProgress();
                    appLogic.game.renderStandard(q);
                },
                renderStandard: (q) => {
                    const stage = document.getElementById('game-stage');
                    stage.innerHTML = `
                        <div id="q-card" class="glass-panel w-full p-6 rounded-2xl flex flex-col items-center justify-center text-center min-h-[300px]">
                            <button onclick="window.app.game.speak('${q.word.replace(/'/g, "\\'")}')" class="w-24 h-24 rounded-full bg-cyber-cyan/10 border border-cyber-cyan text-cyber-cyan flex items-center justify-center animate-pulse-fast mb-4"><i data-lucide="volume-2" class="w-10 h-10"></i></button>
                            <div class="grid w-full gap-3 mt-4" id="options-grid"></div>
                        </div>
                    `;
                    lucide.createIcons();
                    appLogic.game.speak(q.word);
                    const optsDiv = document.getElementById('options-grid');
                    let choices = appLogic.game.getDistractors(q);
                    choices.forEach(c => {
                        const btn = document.createElement('button');
                        btn.className = "w-full py-4 bg-white/5 rounded-xl border border-gray-600 hover:border-cyber-cyan font-bold text-lg";
                        btn.innerText = c.chinese;
                        btn.onclick = () => appLogic.game.checkStandard(c.id === q.id);
                        optsDiv.appendChild(btn);
                    });
                },
                checkStandard: (isCorrect) => {
                    if (isCorrect) {
                        appLogic.state.score += 10;
                        confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
                        setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.nextStandard(); }, 800);
                    } else {
                        appLogic.ui.alert("ç­”éŒ¯äº†", "æ­£ç¢ºç­”æ¡ˆ: " + appLogic.state.quizList[appLogic.state.currentQIndex].chinese);
                        setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.nextStandard(); }, 1000);
                    }
                    document.getElementById('in-game-score').innerText = appLogic.state.score;
                },

                // 2. Match
                startMatchGame: () => {
                    const stage = document.getElementById('game-stage');
                    const batch = appLogic.state.quizList.slice(0, 5); 
                    if(batch.length === 0) { appLogic.game.finish(); return; }
                    
                    let leftItems = [...batch].sort(() => Math.random() - 0.5);
                    let rightItems = [...batch].sort(() => Math.random() - 0.5);
                    let selected = null;
                    let matchesFound = 0;

                    stage.innerHTML = `<div class="grid grid-cols-2 gap-4 w-full h-full content-center" id="match-grid"></div>`;
                    const grid = document.getElementById('match-grid');

                    const render = () => {
                        grid.innerHTML = '';
                        leftItems.forEach(w => {
                            if(!w.matched) grid.innerHTML += `<button data-id="${w.id}" data-type="left" class="match-btn p-4 bg-blue-900/30 border border-blue-500 rounded-lg text-sm font-mono">${w.word}</button>`;
                        });
                        rightItems.forEach(w => {
                            if(!w.matched) grid.innerHTML += `<button data-id="${w.id}" data-type="right" class="match-btn p-4 bg-purple-900/30 border border-purple-500 rounded-lg text-sm">${w.chinese}</button>`;
                        });
                        
                        document.querySelectorAll('.match-btn').forEach(btn => {
                            btn.onclick = (e) => {
                                const id = e.target.getAttribute('data-id');
                                const type = e.target.getAttribute('data-type');
                                
                                if (!selected) {
                                    selected = { id, type, el: e.target };
                                    e.target.classList.add('bg-white/20');
                                } else {
                                    if (selected.type === type) {
                                        selected.el.classList.remove('bg-white/20');
                                        selected = { id, type, el: e.target };
                                        e.target.classList.add('bg-white/20');
                                    } else {
                                        if (selected.id === id) {
                                            appLogic.state.score += 20;
                                            document.getElementById('in-game-score').innerText = appLogic.state.score;
                                            leftItems.find(i=>i.id===id).matched = true;
                                            rightItems.find(i=>i.id===id).matched = true;
                                            matchesFound++;
                                            render();
                                            if(matchesFound === batch.length) {
                                                appLogic.game.finish(); 
                                            }
                                        } else {
                                            selected.el.classList.remove('bg-white/20');
                                            e.target.classList.add('bg-red-500');
                                            setTimeout(()=>e.target.classList.remove('bg-red-500'), 500);
                                            selected = null;
                                        }
                                    }
                                }
                            };
                        });
                    };
                    render();
                },

                // 3. Wheel
                startWheelGame: () => {
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    const stage = document.getElementById('game-stage');
                    
                    stage.innerHTML = `
                        <div class="relative w-64 h-64 mb-8">
                             <div id="wheel" class="w-full h-full rounded-full border-4 border-cyber-cyan flex items-center justify-center bg-black relative shadow-[0_0_30px_#06B6D4]">
                                 <span class="text-4xl">â“</span>
                             </div>
                             <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-4 text-cyber-orange text-4xl">â–¼</div>
                        </div>
                        <button id="spin-btn" class="px-8 py-3 bg-cyber-purple rounded-full font-bold text-lg animate-pulse">SPIN</button>
                        <div id="wheel-q" class="hidden glass-panel p-4 rounded-xl w-full text-center"></div>
                    `;

                    document.getElementById('spin-btn').onclick = () => {
                        const wheel = document.getElementById('wheel');
                        const deg = 720 + Math.random() * 360;
                        wheel.style.transition = "transform 3s cubic-bezier(0.1, 0, 0.2, 1)";
                        wheel.style.transform = `rotate(${deg}deg)`;
                        document.getElementById('spin-btn').classList.add('hidden');
                        
                        setTimeout(() => {
                            wheel.innerHTML = `<span class="text-xl font-bold font-mono text-cyber-cyan">${q.word}</span>`;
                            const qDiv = document.getElementById('wheel-q');
                            qDiv.classList.remove('hidden');
                            qDiv.innerHTML = `<h3 class="mb-4 text-gray-400">è«‹é¸æ“‡æ­£ç¢ºæ„æ€ï¼š</h3>`;
                            
                            let choices = appLogic.game.getDistractors(q);
                            choices.forEach(c => {
                                qDiv.innerHTML += `<button onclick="window.app.game.checkStandard('${c.id===q.id}')" class="block w-full py-3 mb-2 bg-white/5 border border-gray-600 rounded hover:bg-white/10">${c.chinese}</button>`;
                            });
                        }, 3000);
                    };
                },

                // 4. Speed Pop
                startSpeedGame: () => {
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finish(); return; }
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    const stage = document.getElementById('game-stage');
                    
                    stage.innerHTML = `
                        <div class="absolute top-20 text-3xl font-bold font-mono text-white z-0">${q.word}</div>
                        <div id="balloon-area" class="w-full h-full relative overflow-hidden"></div>
                    `;
                    
                    let choices = appLogic.game.getDistractors(q);
                    const area = document.getElementById('balloon-area');
                    
                    choices.forEach((c, i) => {
                        const balloon = document.createElement('div');
                        balloon.className = "balloon absolute p-4 rounded-full bg-gradient-to-br from-red-500 to-pink-600 text-white font-bold text-sm flex items-center justify-center w-24 h-24 shadow-lg border border-white/20";
                        balloon.innerText = c.chinese;
                        balloon.style.left = `${10 + i * 25}%`;
                        balloon.style.top = `-100px`;
                        
                        gsap.to(balloon, {
                            y: window.innerHeight - 200,
                            duration: 4 + Math.random() * 2,
                            ease: "none",
                            onComplete: () => {
                                balloon.remove();
                                if(c.id === q.id) { 
                                    appLogic.ui.alert("æ¼æ‰äº†!", q.chinese);
                                    setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.startSpeedGame(); }, 1000);
                                }
                            }
                        });

                        balloon.onclick = () => {
                            if (c.id === q.id) {
                                appLogic.state.score += 20;
                                document.getElementById('in-game-score').innerText = appLogic.state.score;
                                confetti({ particleCount: 30, origin: { x: (10 + i * 25)/100, y: 0.5 } });
                                gsap.killTweensOf(".balloon");
                                setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.startSpeedGame(); }, 500);
                            } else {
                                balloon.classList.add('scale-0'); 
                                appLogic.state.score = Math.max(0, appLogic.state.score - 5);
                            }
                        };
                        area.appendChild(balloon);
                    });
                },

                // 5. Memory
                startMemoryGame: () => {
                    const stage = document.getElementById('game-stage');
                    const batch = appLogic.state.quizList.slice(0, 6);
                    let cards = [];
                    batch.forEach(w => {
                        cards.push({ id: w.id, content: w.word, type: 'word' });
                        cards.push({ id: w.id, content: w.chinese, type: 'meaning' });
                    });
                    cards.sort(() => Math.random() - 0.5);

                    stage.innerHTML = `<div class="grid grid-cols-3 gap-2 w-full max-w-sm" id="memory-grid"></div>`;
                    const grid = document.getElementById('memory-grid');
                    
                    let flipped = [];
                    let matchedCount = 0;

                    cards.forEach((c, i) => {
                        const el = document.createElement('div');
                        el.className = "card-flip h-24 cursor-pointer";
                        el.innerHTML = `
                            <div class="card-inner w-full h-full">
                                <div class="card-front text-2xl">?</div>
                                <div class="card-back text-sm font-bold p-1">${c.content}</div>
                            </div>
                        `;
                        el.onclick = () => {
                            if (flipped.length < 2 && !el.firstChild.classList.contains('flipped') && !el.classList.contains('matched')) {
                                el.firstChild.classList.add('flipped');
                                flipped.push({ id: c.id, el: el });
                                
                                if (flipped.length === 2) {
                                    if (flipped[0].id === flipped[1].id) {
                                        flipped.forEach(f => f.el.classList.add('matched', 'opacity-50'));
                                        appLogic.state.score += 30;
                                        document.getElementById('in-game-score').innerText = appLogic.state.score;
                                        flipped = [];
                                        matchedCount++;
                                        if (matchedCount === batch.length) appLogic.game.finish();
                                    } else {
                                        setTimeout(() => {
                                            flipped.forEach(f => f.el.firstChild.classList.remove('flipped'));
                                            flipped = [];
                                        }, 1000);
                                    }
                                }
                            }
                        };
                        grid.appendChild(el);
                    });
                },

                getDistractors: (correct) => {
                    let choices = [correct], attempts = 0;
                    while (choices.length < 4 && attempts < 50) {
                        let rnd = appLogic.state.words[Math.floor(Math.random() * appLogic.state.words.length)];
                        if (!choices.find(c => c.id === rnd.id)) choices.push(rnd);
                        attempts++;
                    }
                    return choices.sort(() => Math.random() - 0.5);
                },
                speak: (txt) => { const u = new SpeechSynthesisUtterance(txt); u.lang = 'en-US'; window.speechSynthesis.speak(u); },
                finish: async () => {
                    appLogic.state.score += 100;
                    document.getElementById('res-score').innerText = appLogic.state.score;
                    if (appLogic.state.mode === 'ranked') {
                        const userRef = doc(db, "users", appLogic.state.user.uid);
                        await updateDoc(userRef, { score: increment(appLogic.state.score), weeklyScore: increment(appLogic.state.score), lastPlayed: serverTimestamp() });
                        if (appLogic.state.user.teamId) await updateDoc(doc(db, "teams", appLogic.state.user.teamId), { score: increment(appLogic.state.score) });
                        appLogic.state.user.score += appLogic.state.score;
                        appLogic.ui.updateHeader();
                    }
                    appLogic.nav.to('result');
                }
            },

            team: {
                create: async () => {
                     const name = prompt("éšŠå:", "å‹‡å£«éšŠ"); if(!name) return;
                     const code = Math.random().toString(36).substring(2,8).toUpperCase();
                     const ref = await addDoc(collection(db,"teams"), {code, name, leader: appLogic.state.user.uid, members:[appLogic.state.user.uid], score:0});
                     await updateDoc(doc(db,"users",appLogic.state.user.uid), {teamId: ref.id});
                     appLogic.state.user.teamId = ref.id; appLogic.team.load(ref.id);
                     appLogic.ui.alert("æˆåŠŸ", code);
                },
                join: async () => {
                     const code = prompt("é‚€è«‹ç¢¼:"); if(!code) return;
                     const q = query(collection(db,"teams"), where("code","==",code));
                     const snap = await getDocs(q); if(snap.empty) return;
                     const t = snap.docs[0];
                     await updateDoc(doc(db,"teams",t.id), {members: arrayUnion(appLogic.state.user.uid)});
                     await updateDoc(doc(db,"users",appLogic.state.user.uid), {teamId: t.id});
                     appLogic.state.user.teamId = t.id; appLogic.team.load(t.id);
                     appLogic.ui.alert("æˆåŠŸ", "å·²åŠ å…¥");
                },
                load: (tid) => {
                    onSnapshot(doc(db,"teams",tid), async(d)=>{
                        if(!d.exists()) return;
                        appLogic.state.team = {id:d.id, ...d.data()};
                        const mems = [];
                        for(const u of d.data().members) { const s = await getDoc(doc(db,"users",u)); if(s.exists()) mems.push(s.data()); }
                        const list = document.getElementById('team-members-list');
                        if(list) list.innerHTML = mems.map(m=>`<img src="${m.photoURL}" class="w-8 h-8 rounded-full border border-black">`).join('');
                        document.getElementById('team-code-display').innerText = d.data().code;
                    });
                }
            },
            admin: {
                uploadCSV: () => {
                    const f = document.getElementById('csv-upload').files[0];
                    if(!f) return;
                    Papa.parse(f, {header:true, complete: async(r)=>{
                        const b = writeBatch(db);
                        r.data.forEach(row=>{ if(row['å–®å­—']) b.set(doc(collection(db,"words")), {word:row['å–®å­—'], chinese:row['ä¸­æ–‡'], level:row['ç´šåˆ¥']||'1'}); });
                        await b.commit(); appLogic.ui.alert("æˆåŠŸ","åŒ¯å…¥å®Œæˆ");
                    }});
                },
                hardReset: async () => {
                    if(prompt("ç¢ºèªæ¸…é™¤? è¼¸å…¥ RESET")!=="RESET") return;
                    const u = await getDocs(collection(db,"users")); const ub = writeBatch(db); u.forEach(d=>ub.delete(d.ref)); await ub.commit();
                    const t = await getDocs(collection(db,"teams")); const tb = writeBatch(db); t.forEach(d=>tb.delete(d.ref)); await tb.commit();
                    location.reload();
                }
            },
            leaderboard: {
                renderPreview: async () => {
                    const getRankIcon = (i) => {
                        if(i===0) return CULTURAL_ICONS.lily;  // Rank 1: Lily
                        if(i===1) return CULTURAL_ICONS.pot;   // Rank 2: Pot
                        if(i===2) return CULTURAL_ICONS.snake; // Rank 3: Snake
                        return `<span class="font-bold text-gray-500">No.${i+1}</span>`;
                    };

                    // User Top 3
                    const uQ = query(collection(db, "users"), orderBy("score", "desc"), limit(3));
                    const uSnap = await getDocs(uQ);
                    const uDiv = document.getElementById('login-lb-user');
                    uDiv.innerHTML = uSnap.docs.map((d, i) => 
                        `<div class="flex justify-between items-center bg-white/5 p-2 rounded-lg border border-white/5">
                            <div class="flex items-center gap-2">
                                ${getRankIcon(i)} 
                                <span class="truncate max-w-[80px]">${d.data().displayName}</span>
                            </div> 
                            <span class="text-cyber-cyan font-mono font-bold">${d.data().score}</span>
                        </div>`
                    ).join('');

                    // Team Top 3
                    const tQ = query(collection(db, "teams"), orderBy("score", "desc"), limit(3));
                    const tSnap = await getDocs(tQ);
                    const tDiv = document.getElementById('login-lb-team');
                    tDiv.innerHTML = tSnap.docs.map((d, i) => 
                        `<div class="flex justify-between items-center bg-white/5 p-2 rounded-lg border border-white/5">
                            <div class="flex items-center gap-2">
                                ${getRankIcon(i)} 
                                <span class="truncate max-w-[80px]">${d.data().name}</span>
                            </div> 
                            <span class="text-cyber-purple font-mono font-bold">${d.data().score}</span>
                        </div>`
                    ).join('');
                },
                show: () => { /* Leaderboard View Logic */ },
                switchSubTab: () => { /* Switch Logic */ }
            },

            ui: {
                startTicker: () => {
                    const msgs = [
                        "ğŸ† 105ç­ é–ƒé›»æˆ°éšŠ å‰›å‰›å®Œæˆäº† L4 æ¸¬é©—ï¼Œç†±åŠ›å€¼ +150ï¼",
                        "ğŸ”¥ 208ç­ å°é™³ é”æˆ 50 é€£æ“Šï¼",
                        "ğŸ›¡ï¸ 301ç­ å±åŒ—å‹‡å£« ä½”é ˜äº†æ’è¡Œæ¦œç¬¬ä¸€åï¼",
                        "ğŸŒŸ æ–°çš„å–®å­—åŒ… L6 å·²ç¶“ä¸Šç·šï¼Œå¿«ä¾†æŒ‘æˆ°ï¼"
                    ];
                    setInterval(() => {
                        const t = document.getElementById('ticker-content');
                        if(t) t.innerText = msgs[Math.floor(Math.random() * msgs.length)];
                    }, 5000);
                },
                updateGameProgress: () => {
                     document.getElementById('game-progress').style.width = `${(appLogic.state.currentQIndex / appLogic.state.quizList.length) * 100}%`;
                },
                updateHeader: () => {
                    document.getElementById('header-avatar').src = appLogic.state.user.photoURL;
                    document.getElementById('header-score').innerText = appLogic.state.user.score;
                    document.getElementById('app-header').classList.remove('hidden');
                },
                alert: (t, m) => { document.getElementById('alert-title').innerText=t; document.getElementById('alert-msg').innerText=m; document.getElementById('alert-box').classList.remove('hidden'); },
                bgAnimation: () => {
                    const canvas = document.getElementById('bgCanvas');
                    const ctx = canvas.getContext('2d');
                    let w, h, p = [];
                    const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
                    window.addEventListener('resize', resize); resize();
                    for(let i=0;i<50;i++) p.push({x:Math.random()*w, y:Math.random()*h, vx:(Math.random()-.5)*.5, vy:(Math.random()-.5)*.5, s:Math.random()*2, c:Math.random()>.5?'#06B6D4':'#8B5CF6'});
                    const anim = () => {
                        ctx.clearRect(0,0,w,h);
                        p.forEach(pt => {
                            pt.x+=pt.vx; pt.y+=pt.vy; if(pt.x<0||pt.x>w)pt.vx*=-1; if(pt.y<0||pt.y>h)pt.vy*=-1;
                            ctx.fillStyle=pt.c; ctx.beginPath(); ctx.arc(pt.x,pt.y,pt.s,0,Math.PI*2); ctx.fill();
                        });
                        requestAnimationFrame(anim);
                    };
                    anim();
                }
            },
            nav: { to: (id) => { document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById('view-'+id).classList.remove('hidden'); if(id==='login') document.getElementById('app-header').classList.add('hidden'); else document.getElementById('app-header').classList.remove('hidden'); } }
        };

        window.app = appLogic;
        window.addEventListener('DOMContentLoaded', appLogic.init);
    </script>
</body>
</html>