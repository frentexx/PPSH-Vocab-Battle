<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPSH Vocabulary Battle | å–®å­—æ˜Ÿéš›çˆ­éœ¸</title>
    
    <!-- æ ¸å¿ƒå‡½å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- å­—é«”ï¼šç§‘æŠ€æ„Ÿè‹±æ–‡ + ç¾ä»£é»‘é«”ä¸­æ–‡ -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: { 
                            bg: '#0B0F19', // æ›´æ·±æ²ˆçš„è—é»‘
                            dark: '#1E293B',
                            cyan: '#06B6D4', 
                            purple: '#8B5CF6', 
                            orange: '#F97316', 
                            danger: '#EF4444',
                            glass: 'rgba(15, 23, 42, 0.7)' 
                        }
                    },
                    fontFamily: { 
                        display: ['Orbitron', 'sans-serif'], 
                        body: ['Noto Sans TC', 'sans-serif'] 
                    },
                    animation: { 
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #0B0F19; 
            color: #E2E8F0; 
            font-family: 'Noto Sans TC', sans-serif; 
            min-height: 100vh; 
            overflow-x: hidden; 
            user-select: none;
        }
        
        /* ç‰ˆæœ¬è™Ÿæµ®æ°´å° */
        .version-tag {
            position: fixed;
            top: 10px;
            right: 10px;
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            color: rgba(255,255,255,0.2);
            z-index: 9999;
            pointer-events: none;
        }

        /* ç»ç’ƒæ“¬æ…‹å®¹å™¨ - æ›´ç²¾ç·»çš„é‚Šæ¡† */
        .glass-panel { 
            background: rgba(30, 41, 59, 0.4); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* éš±è—æ²è»¸ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* --- éŠæˆ²ç‰¹å®šæ¨£å¼ --- */

        /* é¡Œå‹ A: æ°£çƒä¸‹è½å‹•ç•« */
        @keyframes balloonFall {
            0% { top: -100px; opacity: 0; transform: scale(0.8); }
            10% { opacity: 1; transform: scale(1); }
            100% { top: 90vh; opacity: 1; }
        }
        .balloon-item {
            position: absolute;
            animation-name: balloonFall;
            animation-timing-function: linear;
            cursor: pointer;
            z-index: 50;
            transition: transform 0.1s;
        }
        .balloon-item:active { transform: scale(0.9); filter: brightness(1.2); }

        /* é¡Œå‹ B: 3D ç¿»ç‰Œ */
        .perspective-1000 { perspective: 1000px; }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .card-flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .card-front {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #06B6D4;
        }
        .card-back {
            background: linear-gradient(135deg, #4c1d95 0%, #2e1065 100%);
            color: white;
            transform: rotateY(180deg);
            border: 1px solid #8B5CF6;
        }
        
        /* éœ“è™¹ç‹‚ç†±æ¨¡å¼èƒŒæ™¯ */
        .neon-frenzy-bg {
            background: linear-gradient(45deg, #ff00cc, #333399, #00ccff);
            background-size: 400% 400%;
            animation: gradientBG 5s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="selection:bg-cyber-cyan selection:text-black">

    <div class="version-tag">Ver 2.0.0</div>
    <canvas id="bgCanvas" class="fixed top-0 left-0 w-full h-full -z-10 opacity-30"></canvas>
    
    <!-- éœ“è™¹ç‹‚ç†±å±¤ (é è¨­é€æ˜) -->
    <div id="frenzy-layer" class="fixed inset-0 pointer-events-none opacity-0 transition-opacity duration-1000 mix-blend-overlay z-0"></div>

    <div id="app-container" class="max-w-md mx-auto min-h-screen relative flex flex-col z-10">
        
        <!-- HEADER -->
        <header id="app-header" class="hidden p-4 flex justify-between items-center glass-panel sticky top-0 z-50 rounded-b-2xl mb-4 border-b-2 border-cyber-cyan/30">
            <div class="flex flex-col leading-none">
                <span class="text-[10px] text-cyber-cyan tracking-widest">PPSH GALAXY</span>
                <span class="font-display font-bold text-lg text-white">BATTLE</span>
            </div>
            <div id="user-status" class="flex items-center gap-2">
                <div class="text-right">
                    <div class="text-[10px] text-gray-400">CREDITS</div>
                    <span id="header-score" class="text-cyber-cyan font-bold font-mono text-lg">0</span>
                </div>
                <img id="header-avatar" src="" class="w-10 h-10 rounded-full border-2 border-cyber-purple bg-black object-cover">
            </div>
        </header>

        <!-- VIEW 1: ç™»å…¥é é¢ (Redesigned) -->
        <section id="view-login" class="flex-1 flex flex-col relative overflow-hidden">
            <div class="flex-1 flex flex-col items-center justify-center p-8 text-center z-10">
                <!-- Layer 1: æ ¡å -->
                <div class="text-xs text-slate-500 tracking-[0.2em] mb-2 font-light">å±æ±ç¸£ç«‹å±åŒ—é«˜ç´šä¸­å­¸</div>
                
                <!-- Layer 2: è‹±æ–‡ä¸»æ¨™ (Main Visual) -->
                <h1 class="text-3xl font-display font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-white to-purple-500 mb-1 drop-shadow-[0_0_15px_rgba(6,182,212,0.5)]">
                    PPSH VOCABULARY<br>BATTLE
                </h1>
                
                <!-- Layer 3: ä¸­æ–‡å‰¯æ¨™ (Secondary) -->
                <div class="text-base text-slate-400 font-light tracking-[0.5em] border-t border-slate-800 pt-3 mt-3 w-full max-w-[200px] mx-auto">
                    å–®å­—æ˜Ÿéš›çˆ­éœ¸
                </div>

                <!-- è£é£¾æ€§å…ƒç´  -->
                <div class="my-10 relative w-full h-32 flex items-center justify-center">
                    <div class="absolute w-40 h-40 bg-cyber-purple/20 rounded-full blur-3xl animate-pulse-slow"></div>
                    <!-- æ’è¡Œæ¦œé è¦½ (ç°¡åŒ–ç‰ˆ) -->
                    <div class="glass-panel w-full p-4 rounded-xl relative z-10 transform rotate-1 hover:rotate-0 transition-transform duration-500">
                        <div class="flex justify-between items-end border-b border-white/10 pb-2 mb-2">
                            <span class="text-xs text-cyber-cyan font-bold">TOP COMMANDERS</span>
                            <i data-lucide="bar-chart-2" class="w-4 h-4 text-gray-500"></i>
                        </div>
                        <div id="login-lb-preview" class="space-y-2 text-xs text-left">
                            <div class="flex items-center gap-2"><span class="text-lg">ğŸŒº</span> <span class="text-gray-300">è®€å–ä¸­...</span></div>
                        </div>
                    </div>
                </div>

                <button onclick="window.app.auth.login()" class="group relative w-full py-4 bg-white/5 border border-white/10 rounded-none skew-x-[-10deg] hover:bg-white/10 transition-all overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                    <div class="skew-x-[10deg] flex items-center justify-center gap-3">
                        <i data-lucide="log-in" class="w-5 h-5 text-cyber-cyan"></i>
                        <span class="font-display font-bold tracking-widest text-white">GOOGLE LOGIN</span>
                    </div>
                </button>
                <p class="text-[10px] text-gray-600 mt-3 font-mono tracking-wide">RESTRICTED: @ppsh.ptc.edu.tw</p>
            </div>

            <!-- åº•éƒ¨è·‘é¦¬ç‡ˆ -->
            <div class="bg-black/80 border-t border-white/5 py-2 absolute bottom-0 w-full z-20 backdrop-blur-sm">
                <div class="marquee-container">
                    <div id="ticker-content" class="marquee-content text-xs text-slate-400 font-mono flex gap-8">
                        <!-- JS å‹•æ…‹å¡«å…¥ -->
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW 2: Dashboard -->
        <section id="view-dashboard" class="hidden flex-1 flex flex-col p-4 gap-6 pb-20">
            <!-- User Status Card -->
            <div class="glass-panel p-5 rounded-xl relative overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-cyber-cyan/10 rounded-full blur-xl"></div>
                <h2 id="dash-name" class="text-xl font-bold text-white relative z-10">å­¸å“¡è¼‰å…¥ä¸­...</h2>
                <p id="dash-team" class="text-xs text-gray-400 mt-1 relative z-10">NO TEAM</p>
                
                <div class="mt-4 pt-4 border-t border-white/10 flex gap-2">
                    <button onclick="window.app.team.create()" class="flex-1 py-2 bg-cyber-cyan/10 border border-cyber-cyan/30 rounded text-xs text-cyber-cyan hover:bg-cyber-cyan/20 transition-colors">å»ºç«‹éšŠä¼</button>
                    <button onclick="window.app.team.join()" class="flex-1 py-2 bg-cyber-purple/10 border border-cyber-purple/30 rounded text-xs text-cyber-purple hover:bg-cyber-purple/20 transition-colors">è¼¸å…¥ä»£ç¢¼</button>
                </div>
                <div id="team-info-box" class="hidden mt-3 p-2 bg-black/30 rounded text-xs text-center border border-white/5">
                    ä»£ç¢¼: <span id="team-code-display" class="font-mono text-white font-bold select-all cursor-pointer"></span>
                </div>
            </div>

            <!-- Game Modes -->
            <div class="space-y-6">
                <!-- Solo -->
                <div>
                    <h3 class="text-[10px] font-display text-gray-500 tracking-[0.2em] mb-3 uppercase">Solo Mission</h3>
                    <div class="grid gap-3">
                        <div onclick="window.app.game.setup('practice', 'standard')" class="glass-panel p-4 rounded-xl flex items-center justify-between cursor-pointer hover:bg-white/5 border-l-2 border-cyber-cyan group transition-all">
                            <div>
                                <h4 class="font-bold text-gray-200 group-hover:text-cyber-cyan">è‡ªä¸»è¨“ç·´ (Self-Study)</h4>
                                <p class="text-[10px] text-gray-500 mt-1">è½éŸ³/æ‹¼å­—/é…å° â€¢ è‡ªé¸é¡Œæ•¸</p>
                            </div>
                            <i data-lucide="book-open" class="text-gray-600 group-hover:text-cyber-cyan"></i>
                        </div>
                    </div>
                </div>

                <!-- Team -->
                <div>
                    <h3 class="text-[10px] font-display text-gray-500 tracking-[0.2em] mb-3 uppercase">Team Battle</h3>
                    <div class="grid gap-3">
                        <!-- Speed Pop -->
                        <div onclick="window.app.game.setup('ranked', 'speed')" class="glass-panel p-4 rounded-xl flex items-center justify-between cursor-pointer hover:bg-white/5 border-l-2 border-red-500 group relative overflow-hidden">
                            <div class="relative z-10">
                                <h4 class="font-bold text-gray-200 group-hover:text-red-400">ç–¾é€Ÿç ´å†° (Speed Pop)</h4>
                                <p class="text-[10px] text-gray-500 mt-1">æ°£çƒåæ‡‰ â€¢ ç©åˆ†è¡åˆº</p>
                            </div>
                            <i data-lucide="zap" class="text-gray-600 group-hover:text-red-500 relative z-10"></i>
                            <div class="absolute inset-0 bg-gradient-to-r from-red-900/0 to-red-900/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        </div>

                        <!-- Memory -->
                        <div onclick="window.app.game.setup('ranked', 'memory')" class="glass-panel p-4 rounded-xl flex items-center justify-between cursor-pointer hover:bg-white/5 border-l-2 border-cyber-purple group relative overflow-hidden">
                            <div class="relative z-10">
                                <h4 class="font-bold text-gray-200 group-hover:text-cyber-purple">è¨˜æ†¶é…å° (Memory)</h4>
                                <p class="text-[10px] text-gray-500 mt-1">ç¿»ç‰Œåˆä½œ â€¢ èƒ½é‡æ”¶é›†</p>
                            </div>
                            <i data-lucide="grid" class="text-gray-600 group-hover:text-cyber-purple relative z-10"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Button (Hidden) -->
            <button id="admin-btn" onclick="window.app.nav.to('admin')" class="hidden fixed bottom-4 right-4 p-3 bg-gray-800 rounded-full text-gray-400 hover:text-white shadow-lg border border-gray-700 z-50">
                <i data-lucide="settings" class="w-4 h-4"></i>
            </button>
        </section>

        <!-- VIEW 3: Setup (Config) -->
        <section id="view-setup" class="hidden flex-1 flex flex-col p-4 gap-6 justify-center">
            <h2 class="text-2xl font-display font-bold text-center text-white">MISSION CONFIG</h2>
            <div class="glass-panel p-6 rounded-2xl space-y-6">
                <!-- Level Select -->
                <div>
                    <label class="block text-xs text-gray-400 mb-2 uppercase">Target Sector</label>
                    <select id="setup-level" class="w-full bg-black/30 border border-gray-600 rounded p-3 text-sm text-white focus:border-cyber-cyan outline-none">
                        <option value="all">å…¨å®‡å®™ (All Levels)</option>
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5</option>
                        <option value="6">Level 6</option>
                    </select>
                </div>
                
                <!-- Count Slider (Fixed) -->
                <div id="setup-count-group">
                    <label class="block text-xs text-gray-400 mb-2 uppercase flex justify-between">
                        <span>é¸æ“‡é¡Œæ•¸</span>
                        <span id="count-val" class="text-cyber-cyan font-bold">10</span>
                    </label>
                    <input type="range" id="setup-count" min="10" max="30" step="5" value="10" class="w-full accent-cyber-cyan h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('count-val').innerText = this.value">
                    <div class="flex justify-between text-[10px] text-gray-600 mt-1"><span>10</span><span>30</span></div>
                </div>

                <div class="space-y-3 pt-4">
                    <button onclick="window.app.game.start()" class="w-full py-3 bg-cyber-cyan text-black font-bold rounded hover:bg-cyan-400 transition-colors shadow-[0_0_15px_rgba(6,182,212,0.4)]">INITIATE</button>
                    <button onclick="window.app.nav.to('dashboard')" class="w-full py-3 text-gray-500 text-sm hover:text-white">ABORT</button>
                </div>
            </div>
        </section>

        <!-- VIEW 4: Game Container -->
        <section id="view-game" class="hidden flex-1 flex flex-col relative overflow-hidden bg-black/40">
            <!-- Top HUD -->
            <div class="absolute top-0 left-0 w-full p-4 z-20 flex justify-between items-start pointer-events-none">
                <button onclick="window.app.game.quit()" class="pointer-events-auto text-white/50 hover:text-white p-2 bg-black/20 rounded-full backdrop-blur-sm"><i data-lucide="x"></i></button>
                
                <div class="flex flex-col items-center">
                    <div id="game-mode-label" class="text-[10px] font-display text-cyber-cyan tracking-widest mb-1">MODE</div>
                    <div class="w-24 h-1.5 bg-gray-800 rounded-full overflow-hidden border border-white/10">
                        <div id="game-progress" class="h-full bg-gradient-to-r from-cyber-cyan to-blue-500 w-0 transition-all duration-300"></div>
                    </div>
                </div>

                <div class="text-right">
                    <div class="text-[10px] text-gray-500">SCORE</div>
                    <div id="in-game-score" class="text-xl font-display font-bold text-cyber-orange">0</div>
                </div>
            </div>

            <!-- Game Stage (Dynamic) -->
            <div id="game-stage" class="flex-1 w-full h-full relative flex flex-col items-center justify-center p-4">
                <!-- Content injected by JS -->
            </div>

            <!-- Danger Line (Speed Pop Only) -->
            <div id="danger-line" class="hidden absolute bottom-0 left-0 w-full h-2 bg-gradient-to-t from-red-600 to-transparent z-10 animate-pulse"></div>
        </section>

        <!-- VIEW 5: Result -->
        <section id="view-result" class="hidden flex-1 flex flex-col p-6 items-center justify-center gap-8 relative">
            <div class="text-center space-y-2 z-10">
                <h2 class="text-3xl font-display font-bold text-white neon-text">MISSION COMPLETE</h2>
                <div class="text-sm text-gray-400 tracking-widest">æœ¬æ¬¡æˆ°æœå ±å‘Š</div>
            </div>

            <div class="glass-panel w-full max-w-sm p-8 rounded-2xl text-center space-y-6 z-10 border-t-4 border-cyber-cyan">
                <div>
                    <div class="text-xs text-gray-500 uppercase tracking-widest mb-1">Total Score</div>
                    <div class="text-6xl font-display font-bold text-white drop-shadow-lg" id="res-score">0</div>
                </div>
                
                <div id="res-stats" class="grid grid-cols-2 gap-4 text-xs">
                    <div class="bg-white/5 p-2 rounded">æ­£ç¢ºç‡: <span id="res-accuracy" class="text-cyber-cyan font-bold">100%</span></div>
                    <div class="bg-white/5 p-2 rounded">é€£æ“Š: <span id="res-streak" class="text-cyber-orange font-bold">0</span></div>
                </div>

                <!-- éŒ¯é¡ŒæŒ‰éˆ• (JS æ§åˆ¶é¡¯ç¤º) -->
                <button id="btn-review-wrong" onclick="window.app.game.startWrongReview()" class="hidden w-full py-2 bg-red-900/30 border border-red-500/50 text-red-300 rounded text-xs hover:bg-red-900/50 flex items-center justify-center gap-2">
                    <i data-lucide="alert-circle" class="w-3 h-3"></i> ç‰¹è¨“éŒ¯é¡Œ (<span id="wrong-count">0</span>)
                </button>

                <div class="grid grid-cols-2 gap-3 pt-4 border-t border-white/10">
                    <button onclick="window.app.nav.to('dashboard')" class="py-3 bg-gray-700/50 rounded font-bold text-sm hover:bg-gray-700">å›é¦–é </button>
                    <button onclick="window.app.game.setup(window.app.state.mode, window.app.state.gameType)" class="py-3 bg-cyber-purple text-white rounded font-bold text-sm hover:bg-purple-600 shadow-lg">å†ç©ä¸€æ¬¡</button>
                </div>
            </div>
        </section>

        <!-- VIEW 6: Admin -->
        <section id="view-admin" class="hidden flex-1 flex flex-col p-4 gap-4">
            <h2 class="text-xl font-bold text-cyber-orange flex gap-2 items-center"><i data-lucide="shield-alert"></i> ADMIN CONSOLE</h2>
            <div class="glass-panel p-4 rounded-xl space-y-4">
                <input type="file" id="csv-upload" accept=".csv" class="block w-full text-xs text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-cyber-purple file:text-white"/>
                <button onclick="window.app.admin.uploadCSV()" class="w-full py-2 bg-blue-600 rounded text-sm font-bold">Process Upload</button>
                <button onclick="window.app.admin.hardReset()" class="w-full py-3 bg-red-900 text-red-100 font-bold rounded text-sm border border-red-500">SYSTEM HARD RESET</button>
                <button onclick="window.app.nav.to('dashboard')" class="w-full py-2 bg-gray-700 rounded text-sm">Exit</button>
            </div>
        </section>

    </div>

    <!-- Alert Modal -->
    <div id="alert-box" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel p-6 rounded-xl max-w-xs w-full text-center border border-cyber-cyan/30 shadow-[0_0_50px_rgba(6,182,212,0.2)]">
            <h3 id="alert-title" class="text-lg font-bold mb-2 text-white">Message</h3>
            <p id="alert-msg" class="text-gray-300 text-sm mb-6 leading-relaxed"></p>
            <button onclick="document.getElementById('alert-box').classList.add('hidden')" class="px-6 py-2 bg-cyber-cyan text-black font-bold rounded w-full hover:bg-cyan-400">ACKNOWLEDGED</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, query, where, getDocs, onSnapshot, limit, orderBy, increment, serverTimestamp, writeBatch, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // Config Placeholder
        const firebaseConfig = {
            apiKey: "AIzaSyCQC4nD1ceknWbYq0DwY461XgPMSpzxzoE",
            authDomain: "ppsh-vocab-battle.firebaseapp.com",
            projectId: "ppsh-vocab-battle",
            storageBucket: "ppsh-vocab-battle.firebasestorage.app",
            messagingSenderId: "687928286974",
            appId: "1:687928286974:web:b79bd4476f63ce9d9bcfaf",
            measurementId: "G-675CNBRSZS"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const googleProvider = new GoogleAuthProvider();
        lucide.createIcons();

        // Cultural Icons SVG
        const ICONS = {
            lily: `<svg viewBox="0 0 100 100" class="w-5 h-5 inline drop-shadow"><path d="M50 20 C60 5 80 20 50 50 C20 20 40 5 50 20 Z" fill="#fff"/><path d="M50 80 C40 95 20 80 50 50 C80 80 60 95 50 80 Z" fill="#fff"/><path d="M20 50 C5 40 20 20 50 50 C20 80 5 60 20 50 Z" fill="#fff"/><path d="M80 50 C95 60 80 80 50 50 C80 20 95 40 80 50 Z" fill="#fff"/><circle cx="50" cy="50" r="6" fill="#DC2626"/></svg>`,
            pot: `<svg viewBox="0 0 100 100" class="w-5 h-5 inline drop-shadow"><path d="M30 30 Q50 90 70 30 L60 20 L40 20 Z" fill="#5D4037"/><circle cx="50" cy="40" r="8" fill="none" stroke="#222" stroke-dasharray="2"/></svg>`,
            snake: `<svg viewBox="0 0 100 100" class="w-5 h-5 inline drop-shadow"><path d="M20 50 L35 30 L50 50 L65 30 L80 50 L65 70 L50 50 L35 70 Z" fill="#111" stroke="#fff" stroke-width="3"/></svg>`
        };

        const appLogic = {
            state: { 
                user: null, team: null, words: [], 
                quizList: [], wrongList: [], currentQIndex: 0, 
                score: 0, streak: 0, correctCount: 0,
                mode: 'practice', gameType: 'standard', 
                timer: null 
            },
            
            init: () => {
                appLogic.ui.bgAnimation();
                appLogic.ui.startTicker();
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        if (!user.email.endsWith("@ppsh.ptc.edu.tw")) { 
                            appLogic.ui.alert("å­˜å–è¢«æ‹’", "åƒ…é™ @ppsh.ptc.edu.tw ç¶²åŸŸ"); 
                            await signOut(auth); return; 
                        }
                        if (["fuwen@ppsh.ptc.edu.tw"].includes(user.email)) document.getElementById('admin-btn').classList.remove('hidden');
                        
                        const userRef = doc(db, "users", user.uid);
                        const userSnap = await getDoc(userRef);
                        if (!userSnap.exists()) {
                            await setDoc(userRef, { email: user.email, displayName: user.displayName, photoURL: user.photoURL, score: 0, weeklyScore: 0, teamId: null, lastPlayed: serverTimestamp() });
                            appLogic.state.user = { uid: user.uid, score: 0, teamId: null, ...user };
                        } else {
                            appLogic.state.user = { uid: user.uid, ...userSnap.data() };
                        }
                        if (appLogic.state.user.teamId) appLogic.team.load(appLogic.state.user.teamId);
                        appLogic.ui.updateHeader();
                        appLogic.nav.to('dashboard');
                    } else {
                        appLogic.nav.to('login');
                        appLogic.leaderboard.renderPreview();
                    }
                });
            },
            
            auth: { login: () => signInWithPopup(auth, googleProvider).catch(e => appLogic.ui.alert("éŒ¯èª¤", e.message)) },

            // --- æ ¸å¿ƒéŠæˆ²å¼•æ“ ---
            game: {
                setup: async (mode, type) => {
                    appLogic.state.mode = mode;
                    appLogic.state.gameType = type;
                    
                    // è‹¥æ˜¯éŒ¯é¡Œç‰¹è¨“æ¨¡å¼ï¼Œè·³é Setup
                    if (mode === 'review') {
                        appLogic.game.start();
                        return;
                    }

                    // ç¢ºä¿æœ‰å–®å­—
                    if (appLogic.state.words.length === 0) {
                        const q = query(collection(db, "words"), limit(600));
                        const snapshot = await getDocs(q);
                        appLogic.state.words = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (appLogic.state.words.length === 0) { appLogic.ui.alert("ç³»çµ±", "ç„¡å–®å­—è³‡æ–™ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡"); return; }
                    }
                    
                    document.getElementById('setup-count-group').style.display = mode === 'ranked' ? 'none' : 'block';
                    appLogic.nav.to('setup');
                },

                start: () => {
                    // åˆå§‹åŒ–è®Šæ•¸
                    appLogic.state.currentQIndex = 0;
                    appLogic.state.score = 0;
                    appLogic.state.streak = 0;
                    appLogic.state.correctCount = 0;
                    appLogic.state.wrongList = []; // é‡ç½®éŒ¯é¡Œåˆ—è¡¨ (é™¤éæ˜¯ç‰¹è¨“æ¨¡å¼)
                    
                    if (appLogic.state.mode !== 'review') {
                        // æ­£å¸¸é¸é¡Œ
                        const level = document.getElementById('setup-level').value;
                        const countVal = appLogic.state.mode === 'ranked' ? 20 : parseInt(document.getElementById('setup-count').value);
                        
                        let pool = appLogic.state.words.filter(w => {
                            if (level === 'all') return true;
                            if (level.includes('-')) { const [min, max] = level.split('-').map(Number); return parseInt(w.level) >= min && parseInt(w.level) <= max; }
                            return w.level === level;
                        });
                        if (pool.length < 5) pool = appLogic.state.words; // Fallback
                        pool.sort(() => Math.random() - 0.5);
                        appLogic.state.quizList = pool.slice(0, countVal);
                    } 
                    // else: review mode uses existing quizList which is already set to wrongList

                    appLogic.nav.to('game');
                    document.getElementById('game-mode-label').innerText = appLogic.state.gameType.toUpperCase();
                    document.getElementById('in-game-score').innerText = "0";
                    document.getElementById('danger-line').classList.add('hidden'); // Reset UI

                    // æ ¹æ“šé¡å‹å•Ÿå‹•
                    if (appLogic.state.gameType === 'speed') appLogic.game.startSpeedGame();
                    else if (appLogic.state.gameType === 'memory') appLogic.game.startMemoryGame();
                    else appLogic.game.nextStandard(); // standard/review uses standard renderer
                },

                quit: () => {
                    if(appLogic.state.timer) clearInterval(appLogic.state.timer);
                    gsap.killTweensOf("*");
                    appLogic.nav.to('dashboard');
                },

                // ---------------------------
                // é¡Œå‹ A: ç–¾é€Ÿç ´å†° (Speed Pop)
                // ---------------------------
                startSpeedGame: () => {
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finish(); return; }
                    
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    appLogic.ui.updateGameProgress();
                    
                    const stage = document.getElementById('game-stage');
                    document.getElementById('danger-line').classList.remove('hidden'); // Show danger line
                    
                    // æ¸…ç©ºèˆå°ä¸¦è¨­ç½®ä¸­å¿ƒé¡Œç›®
                    stage.innerHTML = `
                        <div class="z-0 pointer-events-none flex flex-col items-center animate-pulse-slow">
                            <div class="text-4xl md:text-6xl font-display font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500 drop-shadow-2xl">
                                ${q.word}
                            </div>
                            <div class="text-xs text-cyber-cyan mt-2 tracking-[0.5em] opacity-70">${q.type}</div>
                        </div>
                        <div id="balloon-container" class="absolute inset-0 w-full h-full overflow-hidden"></div>
                    `;

                    // æº–å‚™é¸é … (1 æ­£ç¢º + 2 å¹²æ“¾)
                    let options = appLogic.game.getDistractors(q, 2);
                    // æ··æ·†ä½ç½®
                    options.sort(() => Math.random() - 0.5);

                    const container = document.getElementById('balloon-container');
                    let activeBalloons = 0;

                    options.forEach((opt, i) => {
                        const balloon = document.createElement('div');
                        balloon.className = "balloon-item absolute p-4 w-24 h-24 rounded-full flex items-center justify-center text-center text-sm font-bold shadow-[0_0_20px_rgba(255,255,255,0.2)] border border-white/20 backdrop-blur-md";
                        
                        // æ¨£å¼å€åˆ†
                        if (i === 0) balloon.classList.add('bg-cyber-purple/80', 'text-white');
                        else if (i === 1) balloon.classList.add('bg-blue-600/80', 'text-white');
                        else balloon.classList.add('bg-cyber-cyan/80', 'text-black');

                        balloon.innerText = opt.chinese;
                        
                        // éš¨æ©Ÿ X è»¸ä½ç½® (10% ~ 80%)
                        const leftPos = 10 + Math.random() * 70;
                        balloon.style.left = `${leftPos}%`;
                        
                        // éš¨æ©Ÿå»¶é²è½ä¸‹
                        const delay = i * 0.8; 
                        balloon.style.animationDelay = `${delay}s`;
                        
                        // éš¨é€Ÿåº¦èª¿æ•´ (éš¨é¡Œæ•¸å¢åŠ è®Šå¿«)
                        const speed = Math.max(3, 6 - (appLogic.state.currentQIndex * 0.1));
                        balloon.style.animationDuration = `${speed}s`;

                        // é»æ“Šäº‹ä»¶
                        balloon.onmousedown = () => {
                            balloon.remove();
                            if (opt.id === q.id) {
                                // Correct
                                appLogic.game.handleAnswer(true);
                                container.innerHTML = ''; // Clear all
                                setTimeout(() => {
                                    appLogic.state.currentQIndex++;
                                    appLogic.game.startSpeedGame();
                                }, 500);
                            } else {
                                // Wrong: Break combo, penalize
                                appLogic.game.handleAnswer(false);
                            }
                        };

                        // ç›£è½å‹•ç•«çµæŸ (è§¸åº•)
                        balloon.addEventListener('animationend', () => {
                            balloon.remove();
                            if (opt.id === q.id) {
                                // æ­£ç¢ºç­”æ¡ˆæ‰è½ = å¤±æ•—
                                appLogic.game.handleAnswer(false); // è¦–ç‚ºç­”éŒ¯
                                appLogic.ui.alert("MISS!", `ç­”æ¡ˆæ˜¯ï¼š${q.chinese}`);
                                setTimeout(() => {
                                    appLogic.state.currentQIndex++;
                                    appLogic.game.startSpeedGame();
                                }, 1000);
                            }
                        });

                        container.appendChild(balloon);
                    });
                },

                // ---------------------------
                // é¡Œå‹ B: è¨˜æ†¶é…å° (Memory)
                // ---------------------------
                startMemoryGame: () => {
                    const stage = document.getElementById('game-stage');
                    document.getElementById('danger-line').classList.add('hidden');
                    
                    // ä¸€æ¬¡å– 8 é¡Œ (16 å¼µå¡)
                    const batchSize = 8;
                    // å¦‚æœå‰©é¤˜é¡Œç›®ä¸è¶³ï¼Œå°±å–å‰©ä¸‹çš„
                    const remaining = appLogic.state.quizList.length - appLogic.state.currentQIndex;
                    if (remaining <= 0) { appLogic.game.finish(); return; }
                    
                    const count = Math.min(batchSize, remaining);
                    const currentBatch = appLogic.state.quizList.slice(appLogic.state.currentQIndex, appLogic.state.currentQIndex + count);
                    
                    let cards = [];
                    currentBatch.forEach(w => {
                        cards.push({ id: w.id, content: w.word, type: 'en' });
                        cards.push({ id: w.id, content: w.chinese, type: 'zh' });
                    });
                    cards.sort(() => Math.random() - 0.5);

                    // æ¸²æŸ“ Grid
                    stage.innerHTML = `
                        <div class="mb-4 text-cyber-cyan font-display tracking-widest text-xs">
                            ENERGY COLLECTED: <span id="mem-matched">0</span>/${count}
                        </div>
                        <div class="grid grid-cols-4 gap-3 w-full max-w-md aspect-square perspective-1000" id="memory-grid">
                            <!-- Cards injected here -->
                        </div>
                    `;
                    const grid = document.getElementById('memory-grid');
                    
                    let flippedCards = [];
                    let matchedPairs = 0;
                    let locked = false;

                    cards.forEach(c => {
                        const el = document.createElement('div');
                        el.className = "w-full h-full cursor-pointer group";
                        el.innerHTML = `
                            <div class="card-inner w-full h-full duration-500">
                                <div class="card-front"></div>
                                <div class="card-back text-xs md:text-sm p-1">${c.content}</div>
                            </div>
                        `;
                        
                        el.onclick = () => {
                            if (locked || el.classList.contains('card-flipped') || el.classList.contains('matched')) return;
                            
                            el.classList.add('card-flipped');
                            flippedCards.push({ id: c.id, el: el });

                            if (flippedCards.length === 2) {
                                locked = true;
                                // Check Match
                                if (flippedCards[0].id === flippedCards[1].id) {
                                    // Match!
                                    appLogic.game.handleAnswer(true); // Add score/streak
                                    flippedCards.forEach(card => card.el.classList.add('matched', 'opacity-50', 'pointer-events-none'));
                                    flippedCards = [];
                                    locked = false;
                                    matchedPairs++;
                                    document.getElementById('mem-matched').innerText = matchedPairs;
                                    
                                    if (matchedPairs === count) {
                                        appLogic.ui.alert("SYSTEM", "ENERGY FULL!");
                                        appLogic.state.currentQIndex += count;
                                        setTimeout(appLogic.game.finish, 1000); // ç°¡å–®èµ·è¦‹ï¼ŒMemory ç©ä¸€è¼ªå°±çµç®—
                                    }
                                } else {
                                    // Mismatch
                                    appLogic.game.handleAnswer(false); // Reset streak
                                    setTimeout(() => {
                                        flippedCards.forEach(card => card.el.classList.remove('card-flipped'));
                                        flippedCards = [];
                                        locked = false;
                                    }, 800);
                                }
                            }
                        };
                        grid.appendChild(el);
                    });
                },

                // ---------------------------
                // æ¨™æº–æ¨¡å¼ (Standard / Review)
                // ---------------------------
                nextStandard: () => {
                    // Review mode ä½¿ç”¨ quizList (å·²åœ¨ setup æ›¿æ›æˆ wrongList)
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finish(); return; }
                    
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    appLogic.ui.updateGameProgress();
                    
                    const stage = document.getElementById('game-stage');
                    document.getElementById('danger-line').classList.add('hidden');

                    stage.innerHTML = `
                        <div class="glass-panel w-full max-w-sm p-6 rounded-2xl flex flex-col items-center text-center">
                            <div class="w-full flex justify-between items-center mb-6 border-b border-white/10 pb-2">
                                <span class="text-xs text-gray-500">${q.level ? 'L'+q.level : 'L1'}</span>
                                <span class="text-xs text-gray-500">${q.type}</span>
                            </div>
                            
                            <button onclick="window.app.game.speak('${q.word.replace(/'/g, "\\'")}')" class="w-20 h-20 rounded-full bg-cyber-cyan/10 border border-cyber-cyan text-cyber-cyan flex items-center justify-center hover:bg-cyber-cyan/20 transition-all mb-4">
                                <i data-lucide="volume-2" class="w-8 h-8"></i>
                            </button>
                            
                            <div class="text-xs text-gray-500 mb-6">é»æ“Šç™¼éŸ³</div>

                            <div class="grid w-full gap-3" id="std-options"></div>
                        </div>
                    `;
                    lucide.createIcons();
                    appLogic.game.speak(q.word);

                    const optContainer = document.getElementById('std-options');
                    // Get 3 distractors
                    let options = appLogic.game.getDistractors(q, 3);
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "w-full py-4 bg-white/5 border border-white/10 rounded-xl hover:border-cyber-cyan hover:bg-white/10 transition-all font-bold text-gray-200 text-lg relative overflow-hidden";
                        btn.innerText = opt.chinese;
                        btn.onclick = () => {
                            if (opt.id === q.id) {
                                // Correct
                                btn.classList.add('bg-green-500/20', 'border-green-500');
                                appLogic.game.handleAnswer(true);
                                setTimeout(() => {
                                    appLogic.state.currentQIndex++;
                                    appLogic.game.nextStandard();
                                }, 600);
                            } else {
                                // Wrong
                                btn.classList.add('bg-red-500/20', 'border-red-500');
                                appLogic.game.handleAnswer(false); // Will record wrong word
                                // Show correct one
                                appLogic.ui.alert("WRONG", `æ­£ç¢ºç­”æ¡ˆ: ${q.chinese}`);
                                setTimeout(() => {
                                    appLogic.state.currentQIndex++;
                                    appLogic.game.nextStandard();
                                }, 1500);
                            }
                        };
                        optContainer.appendChild(btn);
                    });
                },

                // é€šç”¨é‚è¼¯ï¼šè™•ç†ç­”é¡Œçµæœ
                handleAnswer: (isCorrect) => {
                    const currentQ = appLogic.state.quizList[appLogic.state.currentQIndex];
                    
                    if (isCorrect) {
                        appLogic.state.score += 10 + (appLogic.state.streak * 2);
                        appLogic.state.streak++;
                        appLogic.state.correctCount++;
                        
                        // GSAP Neon Frenzy check (5 Combo)
                        if (appLogic.state.streak === 5) {
                            appLogic.ui.triggerNeonFrenzy();
                        }
                        
                        document.getElementById('in-game-score').innerText = appLogic.state.score;
                        // Particle effect
                        confetti({
                            particleCount: 30,
                            spread: 50,
                            origin: { y: 0.7 },
                            colors: ['#06B6D4', '#8B5CF6']
                        });
                    } else {
                        appLogic.state.streak = 0;
                        // Record wrong answer if not already recorded
                        if (currentQ && !appLogic.state.wrongList.find(w => w.id === currentQ.id)) {
                            appLogic.state.wrongList.push(currentQ);
                        }
                        // Shake screen
                        gsap.to("#app-container", { x: [-5, 5, -5, 5, 0], duration: 0.3 });
                    }
                },

                getDistractors: (correct, count) => {
                    let choices = [correct];
                    let pool = appLogic.state.words;
                    let safety = 0;
                    while (choices.length < count + 1 && safety < 50) {
                        let rnd = pool[Math.floor(Math.random() * pool.length)];
                        if (!choices.find(c => c.id === rnd.id)) choices.push(rnd);
                        safety++;
                    }
                    return choices.sort(() => Math.random() - 0.5);
                },

                speak: (txt) => {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(txt);
                    u.lang = 'en-US'; 
                    window.speechSynthesis.speak(u);
                },

                finish: async () => {
                    // Update Stats UI
                    document.getElementById('res-score').innerText = appLogic.state.score;
                    const accuracy = Math.round((appLogic.state.correctCount / appLogic.state.quizList.length) * 100) || 0;
                    document.getElementById('res-accuracy').innerText = accuracy + "%";
                    document.getElementById('res-streak').innerText = appLogic.state.streak; // Final streak
                    
                    // Show "Review Wrong" button if needed
                    const reviewBtn = document.getElementById('btn-review-wrong');
                    if (appLogic.state.wrongList.length > 0) {
                        reviewBtn.classList.remove('hidden');
                        document.getElementById('wrong-count').innerText = appLogic.state.wrongList.length;
                    } else {
                        reviewBtn.classList.add('hidden');
                    }

                    // Save Data (if ranked)
                    if (appLogic.state.mode === 'ranked') {
                        try {
                            const userRef = doc(db, "users", appLogic.state.user.uid);
                            await updateDoc(userRef, { 
                                score: increment(appLogic.state.score), 
                                weeklyScore: increment(appLogic.state.score),
                                lastPlayed: serverTimestamp() 
                            });
                            if (appLogic.state.user.teamId) {
                                await updateDoc(doc(db, "teams", appLogic.state.user.teamId), { 
                                    score: increment(appLogic.state.score) 
                                });
                            }
                            appLogic.state.user.score += appLogic.state.score;
                            appLogic.ui.updateHeader();
                        } catch(e) { console.error("Save error", e); }
                    }
                    
                    appLogic.nav.to('result');
                },

                startWrongReview: () => {
                    // ç‰¹è¨“æ¨¡å¼é‚è¼¯
                    appLogic.state.quizList = [...appLogic.state.wrongList]; // è¤‡è£½éŒ¯é¡Œ
                    appLogic.state.mode = 'review';
                    appLogic.state.gameType = 'standard'; // è¤‡ç¿’å¼·åˆ¶ç”¨æ¨™æº–æ¨¡å¼
                    appLogic.game.start();
                }
            },

            // --- UI/UX ---
            ui: {
                startTicker: () => {
                    const msgs = [
                        "SYSTEM: æ­¡è¿é€²å…¥å±åŒ—å–®å­—æ˜Ÿéš›çˆ­éœ¸ v2.0",
                        "RANKING: 105ç­ å‹‡å£«éšŠ å‰›å‰›ä½”é ˜äº†é€±æ¦œç¬¬ä¸€ï¼",
                        "TIP: é€£çºŒç­”å° 5 é¡Œå¯è§¸ç™¼ [éœ“è™¹ç‹‚ç†±] åŠ åˆ†ç‹€æ…‹ï¼",
                        "UPDATE: æ–°å¢ [ç–¾é€Ÿç ´å†°] èˆ‡ [è¨˜æ†¶é…å°] æ¨¡å¼"
                    ];
                    const t = document.getElementById('ticker-content');
                    if(t) t.innerHTML = msgs.map(m => `<span>${m}</span>`).join('<span class="text-cyber-purple px-4">///</span>');
                },
                updateGameProgress: () => {
                     document.getElementById('game-progress').style.width = `${(appLogic.state.currentQIndex / appLogic.state.quizList.length) * 100}%`;
                },
                updateHeader: () => {
                    document.getElementById('header-avatar').src = appLogic.state.user.photoURL;
                    document.getElementById('header-score').innerText = appLogic.state.user.score;
                    document.getElementById('app-header').classList.remove('hidden');
                    document.getElementById('dash-name').innerText = appLogic.state.user.displayName;
                },
                alert: (t, m) => { 
                    document.getElementById('alert-title').innerText=t; 
                    document.getElementById('alert-msg').innerText=m; 
                    document.getElementById('alert-box').classList.remove('hidden'); 
                },
                triggerNeonFrenzy: () => {
                    const layer = document.getElementById('frenzy-layer');
                    layer.classList.add('neon-frenzy-bg', 'opacity-100');
                    setTimeout(() => {
                        layer.classList.remove('opacity-100');
                        setTimeout(() => layer.classList.remove('neon-frenzy-bg'), 1000);
                    }, 2000); // Effect lasts 2s
                },
                bgAnimation: () => { /* Simplified particle loop */ }
            },

            // --- Team & Admin (Minimal Implementation for size) ---
            team: {
                create: async () => { /* Standard logic */ 
                    const name = prompt("éšŠå:"); if(!name) return;
                    const code = Math.random().toString(36).substring(2,8).toUpperCase();
                    const ref = await addDoc(collection(db,"teams"), {code, name, leader: appLogic.state.user.uid, members:[appLogic.state.user.uid], score:0});
                    await updateDoc(doc(db,"users",appLogic.state.user.uid), {teamId: ref.id});
                    appLogic.state.user.teamId = ref.id; appLogic.team.load(ref.id);
                },
                join: async () => { /* Standard logic */ 
                    const code = prompt("ä»£ç¢¼:"); if(!code) return;
                    const q = query(collection(db,"teams"), where("code","==",code));
                    const snap = await getDocs(q); if(snap.empty) { appLogic.ui.alert("Err","ç„¡æ•ˆä»£ç¢¼"); return; }
                    const t = snap.docs[0];
                    await updateDoc(doc(db,"teams",t.id), {members: arrayUnion(appLogic.state.user.uid)});
                    await updateDoc(doc(db,"users",appLogic.state.user.uid), {teamId: t.id});
                    appLogic.state.user.teamId = t.id; appLogic.team.load(t.id);
                },
                load: (tid) => {
                    onSnapshot(doc(db,"teams",tid), async(d)=>{
                        if(!d.exists()) return;
                        appLogic.state.team = {id:d.id, ...d.data()};
                        document.getElementById('dash-team').innerText = d.data().name;
                        document.getElementById('dash-team').classList.add('text-cyber-cyan');
                        document.getElementById('team-code-display').innerText = d.data().code;
                        document.getElementById('team-info-box').classList.remove('hidden');
                    });
                }
            },
            admin: {
                uploadCSV: () => {
                    const f = document.getElementById('csv-upload').files[0];
                    if(!f) return;
                    Papa.parse(f, {header:true, complete: async(r)=>{
                        const b = writeBatch(db);
                        r.data.forEach(row=>{ if(row['å–®å­—']) b.set(doc(collection(db,"words")), {word:row['å–®å­—'], chinese:row['ä¸­æ–‡'], level:row['ç´šåˆ¥']||'1', type:row['å±¬æ€§']||'n.'}); });
                        await b.commit(); appLogic.ui.alert("OK",`åŒ¯å…¥ ${r.data.length} ç­†`);
                    }});
                },
                hardReset: async () => {
                    if(prompt("TYPE RESET")!=="RESET") return;
                    // Mock reset logic
                    appLogic.ui.alert("System", "Data cleared.");
                }
            },
            leaderboard: {
                renderPreview: async () => {
                    const icons = [ICONS.lily, ICONS.pot, ICONS.snake];
                    const uQ = query(collection(db, "users"), orderBy("score", "desc"), limit(3));
                    const uSnap = await getDocs(uQ);
                    document.getElementById('login-lb-preview').innerHTML = uSnap.docs.map((d, i) => 
                        `<div class="flex justify-between items-center bg-white/5 p-2 rounded border-b border-white/5">
                            <div class="flex items-center gap-2">${icons[i]||'<span>'+(i+1)+'</span>'} ${d.data().displayName}</div>
                            <span class="text-cyber-cyan font-mono">${d.data().score}</span>
                        </div>`
                    ).join('');
                }
            },
            nav: { to: (id) => { 
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); 
                document.getElementById('view-'+id).classList.remove('hidden'); 
                if(id==='login') document.getElementById('app-header').classList.add('hidden'); 
                else document.getElementById('app-header').classList.remove('hidden'); 
            }}
        };

        window.app = appLogic;
        window.addEventListener('DOMContentLoaded', appLogic.init);
    </script>
</body>
</html>