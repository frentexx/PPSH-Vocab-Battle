<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPSH Vocabulary Battle | ÂñÆÂ≠óÊòüÈöõÁà≠Èú∏</title>
    
    <!-- Ê†∏ÂøÉÂáΩÂºèÂ∫´ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Â≠óÈ´îÔºöÁßëÊäÄÊÑüËã±Êñá + Áèæ‰ª£ÈªëÈ´î‰∏≠Êñá -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: { 
                            bg: '#0B0F19', 
                            dark: '#1E293B',
                            cyan: '#06B6D4', 
                            purple: '#8B5CF6', 
                            orange: '#F97316', 
                            danger: '#EF4444',
                            glass: 'rgba(15, 23, 42, 0.7)' 
                        }
                    },
                    fontFamily: { 
                        display: ['Orbitron', 'sans-serif'], 
                        body: ['Noto Sans TC', 'sans-serif'] 
                    },
                    animation: { 
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #0B0F19; 
            color: #E2E8F0; 
            font-family: 'Noto Sans TC', sans-serif; 
            min-height: 100vh; 
            overflow-x: hidden; 
            user-select: none;
        }
        
        .version-tag {
            position: fixed;
            top: 10px; right: 10px;
            font-family: 'Orbitron', sans-serif; font-size: 10px;
            color: rgba(255,255,255,0.3);
            z-index: 9999; pointer-events: none;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 2px 6px; border-radius: 4px;
        }

        .glass-panel { 
            background: rgba(30, 41, 59, 0.4); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* --- ÈÅäÊà≤ÁâπÊïà --- */

        /* A: ÁñæÈÄüÁ†¥ÂÜ∞Ê∞£ÁêÉ */
        @keyframes balloonFall {
            0% { top: -120px; opacity: 0; transform: scale(0.8); }
            10% { opacity: 1; transform: scale(1); }
            100% { top: 100vh; opacity: 1; }
        }
        .balloon-item {
            position: absolute;
            animation-name: balloonFall;
            animation-timing-function: linear;
            cursor: pointer;
            z-index: 50;
            transition: transform 0.1s;
            will-change: top;
        }
        .balloon-item:active { transform: scale(0.95); filter: brightness(1.2); }

        /* B: ÊòüÈöõËÉΩÈáèÈõªÊ±† */
        .battery-container {
            width: 100px; height: 240px;
            border: 4px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            position: relative;
            background: rgba(0,0,0,0.3);
            overflow: hidden;
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.2);
        }
        .battery-head {
            width: 40px; height: 10px;
            background: rgba(255,255,255,0.2);
            position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
            border-radius: 4px 4px 0 0;
        }
        .battery-liquid {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 0%; /* Dynamic */
            background: linear-gradient(to top, #8B5CF6, #06B6D4);
            transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1), filter 0.5s;
            box-shadow: 0 0 20px currentColor;
        }
        /* ÈõªÊ±†Ê∂≤È´îÊ≥¢Âãï */
        .battery-liquid::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 10px;
            background: rgba(255,255,255,0.5); opacity: 0.3;
            transform: scaleY(0.5); filter: blur(2px);
        }

        /* ËÉΩÈáèÁ≤íÂ≠ê */
        .energy-particle {
            position: absolute; width: 12px; height: 12px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 0 10px #06B6D4, 0 0 20px #06B6D4;
            pointer-events: none; z-index: 100;
        }

        /* ÈúìËôπÁãÇÁÜ±Ê®°ÂºèËÉåÊôØ */
        .neon-frenzy-bg {
            background: linear-gradient(45deg, rgba(255,0,204,0.2), rgba(51,51,153,0.2), rgba(0,204,255,0.2));
            background-size: 400% 400%;
            animation: gradientBG 2s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="selection:bg-cyber-cyan selection:text-black">

    <div class="version-tag">Ver 2.1.0</div>
    <canvas id="bgCanvas" class="fixed top-0 left-0 w-full h-full -z-10 opacity-30"></canvas>
    <div id="frenzy-layer" class="fixed inset-0 pointer-events-none opacity-0 transition-opacity duration-1000 mix-blend-screen z-0"></div>

    <div id="app-container" class="max-w-md mx-auto min-h-screen relative flex flex-col z-10">
        
        <!-- HEADER -->
        <header id="app-header" class="hidden p-4 flex justify-between items-center glass-panel sticky top-0 z-50 rounded-b-2xl mb-4 border-b border-white/5">
            <div class="flex flex-col leading-none">
                <span class="text-[10px] text-cyber-cyan tracking-widest font-display">PPSH GALAXY</span>
                <span class="font-display font-bold text-lg text-white">BATTLE</span>
            </div>
            <div id="user-status" class="flex items-center gap-2">
                <div class="text-right">
                    <div class="text-[10px] text-gray-400">CREDITS</div>
                    <span id="header-score" class="text-cyber-cyan font-bold font-mono text-lg">0</span>
                </div>
                <img id="header-avatar" src="" class="w-10 h-10 rounded-full border-2 border-cyber-purple bg-black object-cover">
            </div>
        </header>

        <!-- VIEW 1: ÁôªÂÖ• -->
        <section id="view-login" class="flex-1 flex flex-col relative overflow-hidden">
            <div class="flex-1 flex flex-col items-center justify-center p-8 text-center z-10">
                <div class="text-xs text-slate-500 tracking-[0.2em] mb-3 font-light border-b border-slate-800 pb-2">Â±èÊù±Á∏£Á´ãÂ±èÂåóÈ´òÁ¥ö‰∏≠Â≠∏</div>
                <h1 class="text-3xl font-display font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-white to-purple-500 mb-2 drop-shadow-[0_0_15px_rgba(6,182,212,0.3)]">
                    PPSH VOCABULARY<br>BATTLE
                </h1>
                <div class="text-sm text-slate-400 font-light tracking-[0.5em] pt-1">ÂñÆÂ≠óÊòüÈöõÁà≠Èú∏</div>

                <div class="my-12 relative w-full h-32 flex items-center justify-center">
                    <div class="absolute w-40 h-40 bg-cyber-purple/10 rounded-full blur-3xl animate-pulse-slow"></div>
                    <div class="glass-panel w-full p-4 rounded-xl relative z-10 transform hover:scale-[1.02] transition-transform duration-500 border border-white/5">
                        <div class="flex justify-between items-end border-b border-white/10 pb-2 mb-2">
                            <span class="text-[10px] text-cyber-cyan font-bold tracking-widest">TOP COMMANDERS</span>
                            <i data-lucide="bar-chart-2" class="w-4 h-4 text-gray-500"></i>
                        </div>
                        <div id="login-lb-preview" class="space-y-2 text-xs text-left min-h-[60px]">
                            <div class="flex items-center gap-2 text-gray-500"><span class="animate-spin">‚ü≥</span> Ë≥áÊñôÂêåÊ≠•‰∏≠...</div>
                        </div>
                    </div>
                </div>

                <button onclick="window.app.auth.login()" class="group relative w-full py-4 bg-white/5 border border-white/10 rounded hover:bg-white/10 transition-all overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000"></div>
                    <div class="flex items-center justify-center gap-3">
                        <i data-lucide="log-in" class="w-5 h-5 text-cyber-cyan"></i>
                        <span class="font-display font-bold tracking-widest text-white">GOOGLE LOGIN</span>
                    </div>
                </button>
                <p class="text-[10px] text-gray-600 mt-3 font-mono tracking-wide">RESTRICTED: @ppsh.ptc.edu.tw</p>
            </div>
            <div class="bg-black/80 border-t border-white/5 py-2 absolute bottom-0 w-full z-20 backdrop-blur-sm">
                <div class="marquee-container"><div id="ticker-content" class="marquee-content text-xs text-slate-400 font-mono flex gap-8"></div></div>
            </div>
        </section>

        <!-- VIEW 2: Dashboard -->
        <section id="view-dashboard" class="hidden flex-1 flex flex-col p-4 gap-6 pb-20">
            <div class="glass-panel p-5 rounded-xl relative overflow-hidden">
                <div class="absolute -right-6 -top-6 w-32 h-32 bg-cyber-cyan/5 rounded-full blur-2xl"></div>
                <h2 id="dash-name" class="text-xl font-bold text-white relative z-10">ËºâÂÖ•‰∏≠...</h2>
                <p id="dash-team" class="text-xs text-gray-400 mt-1 relative z-10 font-mono">NO TEAM</p>
                <div class="mt-4 pt-4 border-t border-white/10 flex gap-2">
                    <button onclick="window.app.team.create()" class="flex-1 py-2 bg-cyber-cyan/10 border border-cyber-cyan/30 rounded text-xs text-cyber-cyan hover:bg-cyber-cyan/20">Âª∫Á´ãÈöä‰ºç</button>
                    <button onclick="window.app.team.join()" class="flex-1 py-2 bg-cyber-purple/10 border border-cyber-purple/30 rounded text-xs text-cyber-purple hover:bg-cyber-purple/20">Ëº∏ÂÖ•‰ª£Á¢º</button>
                </div>
                <div id="team-info-box" class="hidden mt-3 p-2 bg-black/30 rounded text-xs text-center border border-white/5">
                    ‰ª£Á¢º: <span id="team-code-display" class="font-mono text-white font-bold select-all cursor-pointer"></span>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Solo -->
                <div>
                    <h3 class="text-[10px] font-display text-gray-500 tracking-[0.2em] mb-3 uppercase border-l-2 border-cyber-cyan pl-2">Solo Mission</h3>
                    <div onclick="window.app.game.setup('practice', 'standard')" class="glass-panel p-4 rounded-xl flex items-center justify-between cursor-pointer hover:bg-white/5 group transition-all">
                        <div>
                            <h4 class="font-bold text-gray-200 group-hover:text-cyber-cyan">Ëá™‰∏ªË®ìÁ∑¥ (Self-Study)</h4>
                            <p class="text-[10px] text-gray-500 mt-1">Âü∫Á§éÁ∑¥Áøí ‚Ä¢ ÈåØÈ°åÁâπË®ì</p>
                        </div>
                        <i data-lucide="book-open" class="text-gray-600 group-hover:text-cyber-cyan"></i>
                    </div>
                </div>

                <!-- Team -->
                <div>
                    <h3 class="text-[10px] font-display text-gray-500 tracking-[0.2em] mb-3 uppercase border-l-2 border-cyber-purple pl-2">Team Battle</h3>
                    <div class="grid gap-3">
                        <div onclick="window.app.game.setup('ranked', 'speed')" class="glass-panel p-4 rounded-xl flex items-center justify-between cursor-pointer hover:bg-white/5 border border-transparent hover:border-red-500/30 group relative overflow-hidden">
                            <div class="relative z-10">
                                <h4 class="font-bold text-gray-200 group-hover:text-red-400">üéà ÁñæÈÄüÁ†¥ÂÜ∞ (Speed Pop)</h4>
                                <p class="text-[10px] text-gray-500 mt-1">Ê∞£ÁêÉÂèçÊáâ ‚Ä¢ Á©çÂàÜË°ùÂà∫</p>
                            </div>
                            <i data-lucide="zap" class="text-gray-600 group-hover:text-red-500 relative z-10"></i>
                        </div>

                        <div onclick="window.app.game.setup('ranked', 'energy')" class="glass-panel p-4 rounded-xl flex items-center justify-between cursor-pointer hover:bg-white/5 border border-transparent hover:border-cyber-purple/30 group relative overflow-hidden">
                            <div class="relative z-10">
                                <h4 class="font-bold text-gray-200 group-hover:text-cyber-purple">‚ö° ÊòüÈöõËÉΩÈáèÁ´ô (Energy)</h4>
                                <p class="text-[10px] text-gray-500 mt-1">ÂúòÈöäÂÖ±È¨• ‚Ä¢ ÈõªÊ±†ÂÖÖËÉΩ</p>
                            </div>
                            <i data-lucide="battery-charging" class="text-gray-600 group-hover:text-cyber-purple relative z-10"></i>
                        </div>
                    </div>
                </div>
                
                <div onclick="window.app.leaderboard.show()" class="glass-panel p-3 rounded-xl border border-white/5 text-center cursor-pointer hover:bg-white/5 mt-4">
                    <span class="text-xs font-bold text-gray-400 group-hover:text-white"><i data-lucide="bar-chart-2" class="inline w-3 h-3 mr-1"></i> ÈÄ≤ÂÖ•Êà∞ÊÉÖ‰∏≠ÂøÉ</span>
                </div>
            </div>

            <button id="admin-btn" onclick="window.app.nav.to('admin')" class="hidden fixed bottom-4 right-4 p-3 bg-gray-800 rounded-full text-gray-400 hover:text-white shadow-lg border border-gray-700 z-50">
                <i data-lucide="settings" class="w-4 h-4"></i>
            </button>
        </section>

        <!-- VIEW 3: Setup (Config) -->
        <section id="view-setup" class="hidden flex-1 flex flex-col p-4 gap-6 justify-center">
            <h2 class="text-2xl font-display font-bold text-center text-white tracking-widest">MISSION CONFIG</h2>
            <div class="glass-panel p-6 rounded-2xl space-y-8">
                <div>
                    <label class="block text-xs text-gray-400 mb-2 uppercase tracking-wider">Target Sector</label>
                    <select id="setup-level" class="w-full bg-black/30 border border-gray-600 rounded p-3 text-sm text-white focus:border-cyber-cyan outline-none">
                        <option value="all">ÂÖ®ÂÆáÂÆô (All Levels)</option>
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5</option>
                        <option value="6">Level 6</option>
                    </select>
                </div>
                
                <div id="setup-count-group">
                    <label class="block text-xs text-gray-400 mb-4 uppercase tracking-wider flex justify-between">
                        <span>ÈÅ∏ÊìáÈ°åÊï∏</span>
                        <span id="count-val" class="text-cyber-cyan font-bold font-mono text-lg">10</span>
                    </label>
                    <input type="range" id="setup-count" min="10" max="30" step="5" value="10" class="w-full accent-cyber-cyan h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('count-val').innerText = this.value">
                    <div class="flex justify-between text-[10px] text-gray-600 mt-2 font-mono"><span>10</span><span>20</span><span>30</span></div>
                </div>

                <div class="space-y-3 pt-4">
                    <button onclick="window.app.game.start()" class="w-full py-4 bg-cyber-cyan text-black font-bold font-display tracking-widest rounded hover:bg-cyan-400 transition-colors shadow-[0_0_20px_rgba(6,182,212,0.3)]">INITIATE</button>
                    <button onclick="window.app.nav.to('dashboard')" class="w-full py-3 text-gray-500 text-xs tracking-widest hover:text-white">ABORT</button>
                </div>
            </div>
        </section>

        <!-- VIEW 4: Game Container -->
        <section id="view-game" class="hidden flex-1 flex flex-col relative overflow-hidden bg-black/60">
            <!-- Top HUD -->
            <div class="absolute top-0 left-0 w-full p-4 z-30 flex justify-between items-start pointer-events-none">
                <button onclick="window.app.game.quit()" class="pointer-events-auto text-white/50 hover:text-white p-2 bg-black/30 rounded-full backdrop-blur-sm border border-white/10"><i data-lucide="x"></i></button>
                
                <div class="flex flex-col items-center">
                    <div id="game-mode-label" class="text-[10px] font-display text-cyber-cyan tracking-widest mb-1 shadow-black drop-shadow-md">MODE</div>
                    <div class="w-32 h-1.5 bg-gray-800 rounded-full overflow-hidden border border-white/10">
                        <div id="game-progress" class="h-full bg-gradient-to-r from-cyber-cyan to-blue-500 w-0 transition-all duration-300"></div>
                    </div>
                </div>

                <div class="text-right">
                    <div class="text-[10px] text-gray-500">SCORE</div>
                    <div id="in-game-score" class="text-2xl font-display font-bold text-cyber-orange drop-shadow-md">0</div>
                </div>
            </div>

            <!-- Game Stage (Dynamic) -->
            <div id="game-stage" class="flex-1 w-full h-full relative flex flex-col items-center justify-center p-4 z-10">
                <!-- Content injected by JS -->
            </div>

            <!-- Danger Line (Speed Pop Only) -->
            <div id="danger-line" class="hidden absolute bottom-0 left-0 w-full h-4 bg-gradient-to-t from-red-600/50 to-transparent z-20 animate-pulse pointer-events-none border-b-2 border-red-500"></div>
        </section>

        <!-- VIEW 5: Result -->
        <section id="view-result" class="hidden flex-1 flex flex-col p-6 items-center justify-center gap-8 relative">
            <div class="text-center space-y-2 z-10">
                <h2 class="text-3xl font-display font-bold text-white neon-text">MISSION COMPLETE</h2>
                <div class="text-sm text-gray-400 tracking-widest">Êú¨Ê¨°Êà∞ÊûúÂ†±Âëä</div>
            </div>

            <div class="glass-panel w-full max-w-sm p-8 rounded-2xl text-center space-y-6 z-10 border-t-4 border-cyber-cyan">
                <div>
                    <div class="text-xs text-gray-500 uppercase tracking-widest mb-1">Total Score</div>
                    <div class="text-6xl font-display font-bold text-white drop-shadow-lg" id="res-score">0</div>
                </div>
                
                <div id="res-stats" class="grid grid-cols-2 gap-4 text-xs">
                    <div class="bg-white/5 p-3 rounded border border-white/5">Ê≠£Á¢∫Áéá <br> <span id="res-accuracy" class="text-cyber-cyan font-bold text-lg">100%</span></div>
                    <div class="bg-white/5 p-3 rounded border border-white/5">ÈÄ£Êìä <br> <span id="res-streak" class="text-cyber-orange font-bold text-lg">0</span></div>
                </div>

                <button id="btn-review-wrong" onclick="window.app.game.startWrongReview()" class="hidden w-full py-3 bg-red-900/20 border border-red-500/30 text-red-400 font-bold rounded hover:bg-red-900/40 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="flame" class="w-4 h-4"></i> ÁâπË®ìÈåØÈ°å (<span id="wrong-count">0</span>)
                </button>

                <div class="grid grid-cols-2 gap-3 pt-4 border-t border-white/10">
                    <button onclick="window.app.nav.to('dashboard')" class="py-3 bg-gray-700/50 rounded font-bold text-sm hover:bg-gray-700 transition-colors">ÂõûÈ¶ñÈ†Å</button>
                    <button onclick="window.app.game.setup(window.app.state.mode, window.app.state.gameType)" class="py-3 bg-cyber-purple text-white rounded font-bold text-sm hover:bg-purple-600 shadow-lg transition-colors">ÂÜçÁé©‰∏ÄÊ¨°</button>
                </div>
            </div>
        </section>

        <!-- VIEW 6 & 7: Leaderboard & Admin (Standard) -->
        <section id="view-leaderboard" class="hidden flex-1 flex flex-col p-4 gap-4">
             <div class="flex justify-between items-center"><h2 class="text-xl font-bold font-display text-cyber-purple">INTELLIGENCE</h2><button onclick="window.app.nav.to('dashboard')" class="p-2 hover:text-white"><i data-lucide="x"></i></button></div>
             <div class="glass-panel p-2 rounded-xl flex gap-2"><button id="subtab-user" onclick="window.app.leaderboard.switchSubTab('user')" class="flex-1 py-2 rounded text-xs font-bold tab-active transition-all">ÂÄã‰∫∫ÊéíË°å</button><button id="subtab-team" onclick="window.app.leaderboard.switchSubTab('team')" class="flex-1 py-2 rounded text-xs font-bold text-gray-400 transition-all">ÂúòÈöäÊéíË°å</button></div>
             <div id="lb-detail-content" class="flex-1 overflow-y-auto space-y-2 pb-10"></div>
        </section>

        <section id="view-admin" class="hidden flex-1 flex flex-col p-4 gap-4">
            <h2 class="text-xl font-bold text-cyber-orange flex gap-2 items-center"><i data-lucide="shield-alert"></i> ADMIN CONSOLE</h2>
            <div class="glass-panel p-4 rounded-xl space-y-4">
                <div class="border border-dashed border-gray-600 p-4 rounded text-center"><input type="file" id="csv-upload" accept=".csv" class="block w-full text-xs text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-cyber-purple file:text-white"/></div>
                <button onclick="window.app.admin.uploadCSV()" class="w-full py-2 bg-blue-600 rounded text-sm font-bold">Process Upload</button>
                <hr class="border-gray-700">
                <button onclick="window.app.admin.hardReset()" class="w-full py-3 bg-red-900/50 text-red-200 font-bold rounded text-sm border border-red-500">SYSTEM HARD RESET</button>
                <button onclick="window.app.nav.to('dashboard')" class="w-full py-2 bg-gray-700 rounded text-sm">Exit</button>
            </div>
        </section>
    </div>

    <!-- Alert Modal -->
    <div id="alert-box" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel p-6 rounded-xl max-w-xs w-full text-center border border-cyber-cyan/30 shadow-[0_0_50px_rgba(6,182,212,0.2)]">
            <h3 id="alert-title" class="text-lg font-bold mb-2 text-white font-display">Message</h3>
            <p id="alert-msg" class="text-gray-300 text-sm mb-6 leading-relaxed"></p>
            <button onclick="document.getElementById('alert-box').classList.add('hidden')" class="px-6 py-2 bg-cyber-cyan text-black font-bold rounded w-full hover:bg-cyan-400">ACKNOWLEDGED</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, query, where, getDocs, onSnapshot, limit, orderBy, increment, serverTimestamp, writeBatch, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQC4nD1ceknWbYq0DwY461XgPMSpzxzoE",
            authDomain: "ppsh-vocab-battle.firebaseapp.com",
            projectId: "ppsh-vocab-battle",
            storageBucket: "ppsh-vocab-battle.firebasestorage.app",
            messagingSenderId: "687928286974",
            appId: "1:687928286974:web:b79bd4476f63ce9d9bcfaf",
            measurementId: "G-675CNBRSZS"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const googleProvider = new GoogleAuthProvider();
        lucide.createIcons();

        // Cultural Icons
        const ICONS = {
            lily: `<svg viewBox="0 0 100 100" class="w-5 h-5 inline drop-shadow"><path d="M50 20 C60 5 80 20 50 50 C20 20 40 5 50 20 Z" fill="#fff"/><path d="M50 80 C40 95 20 80 50 50 C80 80 60 95 50 80 Z" fill="#fff"/><path d="M20 50 C5 40 20 20 50 50 C20 80 5 60 20 50 Z" fill="#fff"/><path d="M80 50 C95 60 80 80 50 50 C80 20 95 40 80 50 Z" fill="#fff"/><circle cx="50" cy="50" r="6" fill="#DC2626"/></svg>`,
            pot: `<svg viewBox="0 0 100 100" class="w-5 h-5 inline drop-shadow"><path d="M30 30 Q50 90 70 30 L60 20 L40 20 Z" fill="#5D4037"/><circle cx="50" cy="40" r="8" fill="none" stroke="#222" stroke-dasharray="2"/></svg>`,
            snake: `<svg viewBox="0 0 100 100" class="w-5 h-5 inline drop-shadow"><path d="M20 50 L35 30 L50 50 L65 30 L80 50 L65 70 L50 50 L35 70 Z" fill="#111" stroke="#fff" stroke-width="3"/></svg>`
        };

        const appLogic = {
            state: { 
                user: null, team: null, words: [], 
                quizList: [], wrongList: [], currentQIndex: 0, 
                score: 0, streak: 0, correctCount: 0,
                mode: 'practice', gameType: 'standard', 
                lbSubTab: 'user', timer: null, energyLevel: 0
            },
            
            init: () => {
                appLogic.ui.bgAnimation();
                appLogic.ui.startTicker();
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        if (!user.email.endsWith("@ppsh.ptc.edu.tw")) { appLogic.ui.alert("Â≠òÂèñË¢´Êãí", "ÂÉÖÈôê @ppsh.ptc.edu.tw Á∂≤Âüü"); await signOut(auth); return; }
                        if (["fuwen@ppsh.ptc.edu.tw"].includes(user.email)) document.getElementById('admin-btn').classList.remove('hidden');
                        const userRef = doc(db, "users", user.uid); const userSnap = await getDoc(userRef);
                        if (!userSnap.exists()) await setDoc(userRef, { email: user.email, displayName: user.displayName, photoURL: user.photoURL, score: 0, weeklyScore: 0, teamId: null, lastPlayed: serverTimestamp() });
                        appLogic.state.user = { uid: user.uid, ...userSnap.data() || { score:0 } };
                        if (appLogic.state.user.teamId) appLogic.team.load(appLogic.state.user.teamId);
                        appLogic.ui.updateHeader(); appLogic.nav.to('dashboard');
                    } else {
                        appLogic.nav.to('login'); appLogic.leaderboard.renderPreview();
                    }
                });
            },
            auth: { login: () => signInWithPopup(auth, googleProvider).catch(e => appLogic.ui.alert("ÈåØË™§", e.message)) },

            // --- Ê†∏ÂøÉÈÅäÊà≤ÂºïÊìé ---
            game: {
                setup: async (mode, type) => {
                    appLogic.state.mode = mode;
                    appLogic.state.gameType = type;
                    if (mode === 'review') { appLogic.game.start(); return; } // ÁâπË®ìÁõ¥Êé•ÈñãÂßã
                    if (appLogic.state.words.length === 0) {
                        const q = query(collection(db, "words"), limit(600)); const snapshot = await getDocs(q);
                        appLogic.state.words = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (appLogic.state.words.length === 0) { appLogic.ui.alert("Á≥ªÁµ±", "ÁÑ°ÂñÆÂ≠óË≥áÊñô"); return; }
                    }
                    // Fix: Á¢∫‰øù‰∏çËá™ÂãïÈñãÂßãÔºåÂÖàË∑≥ËΩâÂà∞Ë®≠ÂÆöÈ†Å
                    document.getElementById('setup-count-group').style.display = mode === 'ranked' ? 'none' : 'block';
                    appLogic.nav.to('setup');
                },

                start: () => {
                    // Reset State
                    appLogic.state.currentQIndex = 0; appLogic.state.score = 0;
                    appLogic.state.streak = 0; appLogic.state.correctCount = 0;
                    appLogic.state.energyLevel = 0;
                    if (appLogic.state.timer) clearInterval(appLogic.state.timer);
                    
                    if (appLogic.state.mode !== 'review') {
                        appLogic.state.wrongList = [];
                        const level = document.getElementById('setup-level').value;
                        const countVal = appLogic.state.mode === 'ranked' ? 20 : parseInt(document.getElementById('setup-count').value);
                        let pool = appLogic.state.words.filter(w => {
                            if (level === 'all') return true;
                            if (level.includes('-')) { const [min, max] = level.split('-').map(Number); return parseInt(w.level) >= min && parseInt(w.level) <= max; }
                            return w.level === level;
                        });
                        if (pool.length < 5) pool = appLogic.state.words;
                        pool.sort(() => Math.random() - 0.5);
                        appLogic.state.quizList = pool.slice(0, countVal);
                    }

                    appLogic.nav.to('game');
                    document.getElementById('game-mode-label').innerText = appLogic.state.gameType.toUpperCase();
                    document.getElementById('in-game-score').innerText = "0";
                    document.getElementById('danger-line').classList.add('hidden');

                    // Router
                    if (appLogic.state.gameType === 'speed') appLogic.game.startSpeedGame();
                    else if (appLogic.state.gameType === 'energy') appLogic.game.startEnergyGame();
                    else appLogic.game.nextStandard(); 
                },

                quit: () => { gsap.killTweensOf("*"); appLogic.nav.to('dashboard'); },

                // --- È°åÂûã A: ÁñæÈÄüÁ†¥ÂÜ∞ (Speed Pop) ---
                startSpeedGame: () => {
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finish(); return; }
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    appLogic.ui.updateGameProgress();
                    const stage = document.getElementById('game-stage');
                    document.getElementById('danger-line').classList.remove('hidden');
                    
                    stage.innerHTML = `
                        <div class="z-0 pointer-events-none flex flex-col items-center animate-pulse-slow">
                            <div class="text-4xl md:text-6xl font-display font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500 drop-shadow-2xl text-center">${q.word}</div>
                            <div class="text-xs text-cyber-cyan mt-2 tracking-[0.5em] opacity-70">${q.type || 'VOCAB'}</div>
                        </div>
                        <div id="balloon-container" class="absolute inset-0 w-full h-full overflow-hidden"></div>
                    `;

                    let options = appLogic.game.getDistractors(q, 2); options.sort(() => Math.random() - 0.5);
                    const container = document.getElementById('balloon-container');

                    options.forEach((opt, i) => {
                        const balloon = document.createElement('div');
                        balloon.className = "balloon-item absolute p-4 w-24 h-24 rounded-full flex items-center justify-center text-center text-sm font-bold shadow-[0_0_20px_rgba(255,255,255,0.2)] border border-white/20 backdrop-blur-md";
                        if (i === 0) balloon.classList.add('bg-cyber-purple/80', 'text-white');
                        else if (i === 1) balloon.classList.add('bg-blue-600/80', 'text-white');
                        else balloon.classList.add('bg-cyber-cyan/80', 'text-black');
                        balloon.innerText = opt.chinese;
                        
                        balloon.style.left = `${10 + Math.random() * 70}%`;
                        balloon.style.animationDelay = `${i * 0.8}s`;
                        balloon.style.animationDuration = `${Math.max(3, 6 - (appLogic.state.currentQIndex * 0.15))}s`;

                        balloon.onmousedown = () => {
                            balloon.remove();
                            if (opt.id === q.id) { appLogic.game.handleAnswer(true); container.innerHTML = ''; setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.startSpeedGame(); }, 300); }
                            else { appLogic.game.handleAnswer(false); }
                        };
                        balloon.addEventListener('animationend', () => {
                            balloon.remove();
                            if (opt.id === q.id) { appLogic.game.handleAnswer(false); appLogic.ui.alert("MISS!", `Á≠îÊ°àÔºö${q.chinese}`); setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.startSpeedGame(); }, 1000); }
                        });
                        container.appendChild(balloon);
                    });
                },

                // --- È°åÂûã B: ÊòüÈöõËÉΩÈáèÁ´ô (Energy Station) ---
                startEnergyGame: () => {
                    const stage = document.getElementById('game-stage');
                    document.getElementById('danger-line').classList.add('hidden');
                    
                    stage.innerHTML = `
                        <div class="relative w-full h-full flex flex-col items-center justify-end pb-20">
                            <!-- Battery -->
                            <div class="battery-container absolute top-10 left-1/2 transform -translate-x-1/2 z-0">
                                <div class="battery-head"></div>
                                <div id="battery-liquid" class="battery-liquid"></div>
                            </div>
                            
                            <!-- Question Area (Pop-up above Avatar) -->
                            <div id="question-popup" class="glass-panel p-4 rounded-xl border border-cyber-cyan/50 mb-4 w-64 text-center transform transition-all z-20">
                                <div id="en-q-content" class="min-h-[100px] flex items-center justify-center">ËºâÂÖ•‰∏≠...</div>
                            </div>

                            <!-- Avatar -->
                            <div class="w-16 h-16 rounded-full border-2 border-cyber-cyan p-1 bg-black z-20 relative">
                                <img src="${appLogic.state.user.photoURL}" class="w-full h-full rounded-full object-cover">
                                <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 text-[10px] bg-cyber-cyan text-black px-2 rounded-full font-bold">YOU</div>
                            </div>
                            
                            <!-- Teammates (Decor) -->
                            <div class="absolute top-40 left-10 opacity-50 scale-75 animate-pulse"><div class="w-12 h-12 rounded-full bg-gray-700 border border-gray-500"></div></div>
                            <div class="absolute top-40 right-10 opacity-50 scale-75 animate-pulse delay-700"><div class="w-12 h-12 rounded-full bg-gray-700 border border-gray-500"></div></div>
                        </div>
                    `;
                    
                    // Ê®°Êì¨ÈöäÂèãË≤¢ÁçªÁâπÊïà
                    appLogic.state.timer = setInterval(() => {
                        if(Math.random() > 0.7) appLogic.game.energyBeamEffect(Math.random() > 0.5 ? 'left' : 'right');
                    }, 2000);

                    appLogic.game.nextEnergyQuestion();
                },

                nextEnergyQuestion: () => {
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finish(); return; }
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    appLogic.ui.updateGameProgress();

                    const container = document.getElementById('en-q-content');
                    container.innerHTML = `
                        <div class="mb-3">
                            <span class="text-xl font-bold text-white">${q.word}</span>
                            <div class="text-xs text-gray-400">${q.type}</div>
                        </div>
                        <div class="grid grid-cols-1 gap-2 w-full" id="en-opts"></div>
                    `;
                    
                    let options = appLogic.game.getDistractors(q, 3);
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "w-full py-2 bg-white/10 rounded border border-white/10 hover:bg-cyber-cyan/20 text-sm";
                        btn.innerText = opt.chinese;
                        btn.onclick = () => {
                            if (opt.id === q.id) {
                                // Correct
                                appLogic.game.energyBeamEffect('center'); // Beam from user
                                appLogic.game.handleAnswer(true);
                                appLogic.state.energyLevel += (100 / appLogic.state.quizList.length);
                                const liquid = document.getElementById('battery-liquid');
                                liquid.style.height = `${appLogic.state.energyLevel}%`;
                                
                                // Color Change
                                if(appLogic.state.energyLevel > 60) liquid.style.background = "linear-gradient(to top, #F59E0B, #FCD34D)"; // Gold
                                else if(appLogic.state.energyLevel > 30) liquid.style.background = "linear-gradient(to top, #06B6D4, #67E8F9)"; // Cyan
                                
                                setTimeout(() => {
                                    appLogic.state.currentQIndex++;
                                    appLogic.game.nextEnergyQuestion();
                                }, 600);
                            } else {
                                appLogic.game.handleAnswer(false);
                                appLogic.ui.alert("WRONG", q.chinese);
                                setTimeout(() => {
                                    appLogic.state.currentQIndex++;
                                    appLogic.game.nextEnergyQuestion();
                                }, 1000);
                            }
                        };
                        document.getElementById('en-opts').appendChild(btn);
                    });
                },

                energyBeamEffect: (source) => {
                    const stage = document.getElementById('game-stage');
                    if(!stage) return;
                    const particle = document.createElement('div');
                    particle.className = 'energy-particle';
                    stage.appendChild(particle);
                    
                    let startX = window.innerWidth / 2;
                    let startY = window.innerHeight - 100;
                    if (source === 'left') { startX = 50; startY = 200; }
                    if (source === 'right') { startX = window.innerWidth - 50; startY = 200; }

                    gsap.fromTo(particle, 
                        { x: startX, y: startY, opacity: 1 },
                        { 
                            x: window.innerWidth / 2, y: 150, opacity: 0, duration: 0.6, ease: "power2.in",
                            onComplete: () => { 
                                particle.remove();
                                const bat = document.querySelector('.battery-container');
                                if(bat) {
                                    gsap.to(bat, {scale: 1.1, duration: 0.1, yoyo: true, repeat: 1});
                                }
                            }
                        }
                    );
                },

                // --- Standard (Review) ---
                nextStandard: () => {
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finish(); return; }
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    appLogic.ui.updateGameProgress();
                    const stage = document.getElementById('game-stage');
                    document.getElementById('danger-line').classList.add('hidden');

                    stage.innerHTML = `
                        <div class="glass-panel w-full max-w-sm p-6 rounded-2xl flex flex-col items-center text-center">
                            <div class="w-full flex justify-between items-center mb-6 border-b border-white/10 pb-2">
                                <span class="text-xs text-gray-500 font-mono">${q.level ? 'LEVEL '+q.level : 'LEVEL 1'}</span>
                                <span class="text-xs text-cyber-cyan font-mono tracking-widest">${q.type || 'N.'}</span>
                            </div>
                            <button onclick="window.app.game.speak('${q.word.replace(/'/g, "\\'")}')" class="w-20 h-20 rounded-full bg-cyber-cyan/10 border border-cyber-cyan text-cyber-cyan flex items-center justify-center hover:bg-cyber-cyan/20 transition-all mb-4 animate-pulse-slow"><i data-lucide="volume-2" class="w-8 h-8"></i></button>
                            <div class="text-xs text-gray-500 mb-6 tracking-wider">ÈªûÊìäÁôºÈü≥</div>
                            <div class="grid w-full gap-3" id="std-options"></div>
                        </div>
                    `;
                    lucide.createIcons();
                    appLogic.game.speak(q.word);

                    const optContainer = document.getElementById('std-options');
                    let options = appLogic.game.getDistractors(q, 3);
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "w-full py-4 bg-white/5 border border-white/10 rounded-xl hover:border-cyber-cyan hover:bg-white/10 transition-all font-bold text-gray-200 text-lg relative overflow-hidden active:scale-95";
                        btn.innerText = opt.chinese;
                        btn.onclick = () => {
                            if (opt.id === q.id) {
                                btn.classList.add('bg-green-500/20', 'border-green-500');
                                appLogic.game.handleAnswer(true);
                                setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.nextStandard(); }, 600);
                            } else {
                                btn.classList.add('bg-red-500/20', 'border-red-500');
                                appLogic.game.handleAnswer(false);
                                appLogic.ui.alert("WRONG", `Ê≠£Á¢∫Á≠îÊ°à: ${q.chinese}`);
                                setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.nextStandard(); }, 1500);
                            }
                        };
                        optContainer.appendChild(btn);
                    });
                },

                handleAnswer: (isCorrect) => {
                    const currentQ = appLogic.state.quizList[appLogic.state.currentQIndex];
                    if (isCorrect) {
                        appLogic.state.score += 10 + (appLogic.state.streak * 2);
                        appLogic.state.streak++; appLogic.state.correctCount++;
                        if (appLogic.state.streak === 5) appLogic.ui.triggerNeonFrenzy();
                        document.getElementById('in-game-score').innerText = appLogic.state.score;
                        confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 }, colors: ['#06B6D4', '#8B5CF6'] });
                    } else {
                        appLogic.state.streak = 0;
                        if (currentQ && !appLogic.state.wrongList.find(w => w.id === currentQ.id)) appLogic.state.wrongList.push(currentQ);
                        gsap.to("#app-container", { x: [-5, 5, -5, 5, 0], duration: 0.3 });
                    }
                },

                getDistractors: (correct, count) => {
                    let choices = [correct]; let pool = appLogic.state.words; let safety = 0;
                    while (choices.length < count + 1 && safety < 50) {
                        let rnd = pool[Math.floor(Math.random() * pool.length)];
                        if (!choices.find(c => c.id === rnd.id)) choices.push(rnd);
                        safety++;
                    }
                    return choices.sort(() => Math.random() - 0.5);
                },
                speak: (txt) => { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(txt); u.lang = 'en-US'; window.speechSynthesis.speak(u); },
                
                finish: async () => {
                    if(appLogic.state.timer) clearInterval(appLogic.state.timer);
                    document.getElementById('res-score').innerText = appLogic.state.score;
                    document.getElementById('res-accuracy').innerText = (Math.round((appLogic.state.correctCount / appLogic.state.quizList.length) * 100) || 0) + "%";
                    document.getElementById('res-streak').innerText = appLogic.state.streak;
                    
                    const reviewBtn = document.getElementById('btn-review-wrong');
                    if (appLogic.state.wrongList.length > 0) {
                        reviewBtn.classList.remove('hidden'); document.getElementById('wrong-count').innerText = appLogic.state.wrongList.length;
                    } else { reviewBtn.classList.add('hidden'); }

                    if (appLogic.state.mode === 'ranked') {
                        try {
                            const userRef = doc(db, "users", appLogic.state.user.uid);
                            await updateDoc(userRef, { score: increment(appLogic.state.score), weeklyScore: increment(appLogic.state.score), lastPlayed: serverTimestamp() });
                            if (appLogic.state.user.teamId) await updateDoc(doc(db, "teams", appLogic.state.user.teamId), { score: increment(appLogic.state.score) });
                            appLogic.state.user.score += appLogic.state.score; appLogic.ui.updateHeader();
                        } catch(e) { console.error(e); }
                    }
                    appLogic.nav.to('result');
                },
                startWrongReview: () => {
                    appLogic.state.quizList = [...appLogic.state.wrongList];
                    appLogic.state.mode = 'review'; appLogic.state.gameType = 'standard';
                    appLogic.game.start();
                }
            },

            ui: {
                startTicker: () => {
                    const msgs = ["SYSTEM: Ê≠°ËøéÈÄ≤ÂÖ•Â±èÂåóÂñÆÂ≠óÊòüÈöõÁà≠Èú∏ Ver 2.1.0", "RANKING: 105Áè≠ ÂãáÂ£´Èöä ÂâõÂâõ‰ΩîÈ†ò‰∫ÜÈÄ±Ê¶úÁ¨¨‰∏ÄÔºÅ", "TIP: ÈÄ£Á∫åÁ≠îÂ∞ç 5 È°åÂèØËß∏Áôº [ÈúìËôπÁãÇÁÜ±] Âä†ÂàÜÁãÄÊÖãÔºÅ"];
                    const t = document.getElementById('ticker-content'); if(t) t.innerHTML = msgs.map(m => `<span>${m}</span>`).join('<span class="text-cyber-purple px-4">///</span>');
                },
                updateGameProgress: () => { document.getElementById('game-progress').style.width = `${(appLogic.state.currentQIndex / appLogic.state.quizList.length) * 100}%`; },
                updateHeader: () => { document.getElementById('header-avatar').src = appLogic.state.user.photoURL; document.getElementById('header-score').innerText = appLogic.state.user.score; document.getElementById('app-header').classList.remove('hidden'); document.getElementById('dash-name').innerText = appLogic.state.user.displayName; },
                alert: (t, m) => { document.getElementById('alert-title').innerText=t; document.getElementById('alert-msg').innerText=m; document.getElementById('alert-box').classList.remove('hidden'); },
                triggerNeonFrenzy: () => { const layer = document.getElementById('frenzy-layer'); layer.classList.add('neon-frenzy-bg', 'opacity-100'); setTimeout(() => { layer.classList.remove('opacity-100'); setTimeout(() => layer.classList.remove('neon-frenzy-bg'), 1000); }, 2000); },
                bgAnimation: () => {
                    const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d');
                    let w, h, p = [];
                    const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
                    window.addEventListener('resize', resize); resize();
                    for(let i=0;i<50;i++) p.push({x:Math.random()*w, y:Math.random()*h, vx:(Math.random()-.5)*.5, vy:(Math.random()-.5)*.5, s:Math.random()*2, c:Math.random()>.5?'#06B6D4':'#8B5CF6'});
                    const anim = () => {
                        ctx.clearRect(0,0,w,h);
                        p.forEach(pt => { pt.x+=pt.vx; pt.y+=pt.vy; if(pt.x<0||pt.x>w)pt.vx*=-1; if(pt.y<0||pt.y>h)pt.vy*=-1; ctx.fillStyle=pt.c; ctx.beginPath(); ctx.arc(pt.x,pt.y,pt.s,0,Math.PI*2); ctx.fill(); });
                        requestAnimationFrame(anim);
                    }; anim();
                }
            },
            team: {
                create: async () => { const name = prompt("ÈöäÂêç:"); if(!name) return; const code = Math.random().toString(36).substring(2,8).toUpperCase(); const ref = await addDoc(collection(db,"teams"), {code, name, leader: appLogic.state.user.uid, members:[appLogic.state.user.uid], score:0}); await updateDoc(doc(db,"users",appLogic.state.user.uid), {teamId: ref.id}); appLogic.state.user.teamId = ref.id; appLogic.team.load(ref.id); appLogic.ui.alert("ÊàêÂäü", `‰ª£Á¢º: ${code}`); },
                join: async () => { const code = prompt("Ëº∏ÂÖ•‰ª£Á¢º:"); if(!code) return; const q = query(collection(db,"teams"), where("code","==",code)); const snap = await getDocs(q); if(snap.empty) { appLogic.ui.alert("Err","ÁÑ°Êïà‰ª£Á¢º"); return; } const t = snap.docs[0]; await updateDoc(doc(db,"teams",t.id), {members: arrayUnion(appLogic.state.user.uid)}); await updateDoc(doc(db,"users",appLogic.state.user.uid), {teamId: t.id}); appLogic.state.user.teamId = t.id; appLogic.team.load(t.id); appLogic.ui.alert("ÊàêÂäü", "Â∑≤Âä†ÂÖ•"); },
                load: (tid) => { onSnapshot(doc(db,"teams",tid), async(d)=>{ if(!d.exists()) return; appLogic.state.team = {id:d.id, ...d.data()}; document.getElementById('dash-team').innerText = d.data().name; document.getElementById('dash-team').classList.add('text-cyber-cyan'); document.getElementById('team-code-display').innerText = d.data().code; document.getElementById('team-info-box').classList.remove('hidden'); }); }
            },
            admin: {
                uploadCSV: () => { const f = document.getElementById('csv-upload').files[0]; if(!f) return; Papa.parse(f, {header:true, complete: async(r)=>{ const b = writeBatch(db); r.data.forEach(row=>{ if(row['ÂñÆÂ≠ó']) b.set(doc(collection(db,"words")), {word:row['ÂñÆÂ≠ó'], chinese:row['‰∏≠Êñá'], level:row['Á¥öÂà•']||'1', type:row['Â±¨ÊÄß']||'n.'}); }); await b.commit(); appLogic.ui.alert("OK",`ÂåØÂÖ• ${r.data.length} Á≠Ü`); }}); },
                hardReset: async () => { if(prompt("TYPE RESET")!=="RESET") return; const u = await getDocs(collection(db,"users")); const ub = writeBatch(db); u.forEach(d=>ub.delete(d.ref)); await ub.commit(); const t = await getDocs(collection(db,"teams")); const tb = writeBatch(db); t.forEach(d=>tb.delete(d.ref)); await tb.commit(); location.reload(); }
            },
            leaderboard: {
                renderPreview: async () => { const icons = [ICONS.lily, ICONS.pot, ICONS.snake]; const uQ = query(collection(db, "users"), orderBy("score", "desc"), limit(3)); const uSnap = await getDocs(uQ); document.getElementById('login-lb-preview').innerHTML = uSnap.docs.map((d, i) => `<div class="flex justify-between items-center bg-white/5 p-2 rounded border-b border-white/5"><div class="flex items-center gap-2">${icons[i]||'<span>'+(i+1)+'</span>'} ${d.data().displayName}</div><span class="text-cyber-cyan font-mono">${d.data().score}</span></div>`).join(''); },
                show: () => { appLogic.nav.to('leaderboard'); appLogic.leaderboard.fetchData(); },
                switchSubTab: (subTab) => { appLogic.state.lbSubTab = subTab; const userBtn = document.getElementById('subtab-user'); const teamBtn = document.getElementById('subtab-team'); if(subTab === 'user') { userBtn.classList.add('tab-active'); userBtn.classList.remove('text-gray-400'); teamBtn.classList.remove('tab-active'); teamBtn.classList.add('text-gray-400'); } else { teamBtn.classList.add('tab-active'); teamBtn.classList.remove('text-gray-400'); userBtn.classList.remove('tab-active'); userBtn.classList.add('text-gray-400'); } appLogic.leaderboard.fetchData(); },
                fetchData: async () => { const container = document.getElementById('lb-detail-content'); container.innerHTML = '<div class="text-center text-gray-500 py-4">ËÆÄÂèñ‰∏≠...</div>'; try { let q; if (appLogic.state.lbSubTab === 'team') { q = query(collection(db, "teams"), orderBy("score", "desc"), limit(20)); } else { q = query(collection(db, "users"), orderBy("score", "desc"), limit(20)); } const snapshot = await getDocs(q); if (snapshot.empty) { container.innerHTML = `<div class="text-center text-gray-400 mt-10">Êö´ÁÑ°Ë≥áÊñô</div>`; } else { const icons = [ICONS.lily, ICONS.pot, ICONS.snake]; let html = ''; snapshot.docs.forEach((doc, index) => { const data = doc.data(); const score = data.score || 0; let name, img; if (appLogic.state.lbSubTab === 'team') { name = data.name || "Unknown"; img = "https://api.dicebear.com/7.x/identicon/svg?seed=" + doc.id; } else { name = data.displayName; img = data.photoURL; } html += `<div class="flex items-center justify-between p-3 rounded-xl border border-white/5 bg-white/5"><div class="flex items-center gap-3"><div class="flex items-center justify-center w-8 h-8 font-display font-bold text-xl ${index < 3 ? 'text-cyber-orange' : 'text-gray-500'}">${index < 3 ? icons[index] : index + 1}</div><img src="${img}" class="w-8 h-8 rounded-full bg-black object-cover"><div class="flex flex-col"><span class="text-sm font-bold text-gray-200">${name}</span></div></div><div class="font-mono font-bold text-cyber-cyan">${score}</div></div>`; }); container.innerHTML = html; } } catch (e) { container.innerHTML = `<div class="text-center text-red-400 mt-4">ËºâÂÖ•Â§±Êïó</div>`; } }
            },
            nav: { to: (id) => { document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById('view-'+id).classList.remove('hidden'); if(id==='login') document.getElementById('app-header').classList.add('hidden'); else document.getElementById('app-header').classList.remove('hidden'); }}
        };

        window.app = appLogic;
        window.addEventListener('DOMContentLoaded', appLogic.init);
    </script>
</body>
</html>