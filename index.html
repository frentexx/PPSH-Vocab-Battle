<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPSH Vocabulary Battle | å–®å­—æ˜Ÿéš›çˆ­éœ¸</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: { 
                            bg: '#0B0F19', 
                            card: '#131B2E',
                            cyan: '#06B6D4', 
                            purple: '#8B5CF6', 
                            orange: '#F97316', 
                            yellow: '#FACC15',
                            green: '#22C55E',
                            danger: '#EF4444'
                        }
                    },
                    fontFamily: { 
                        display: ['Orbitron', 'sans-serif'], 
                        body: ['Noto Sans TC', 'sans-serif'] 
                    },
                    animation: { 
                        'radar-spin': 'spin 4s linear infinite',
                        'pulse-glow': 'pulseGlow 2s ease-in-out infinite'
                    },
                    keyframes: {
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 20px rgba(6, 182, 212, 0.2)' },
                            '50%': { boxShadow: '0 0 40px rgba(6, 182, 212, 0.5)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #0B0F19; 
            color: #E2E8F0; 
            font-family: 'Noto Sans TC', sans-serif; 
            min-height: 100vh; 
            overflow-x: hidden; 
            user-select: none;
        }
        
        .version-tag {
            position: fixed; top: 10px; right: 10px; font-family: 'Orbitron'; font-size: 10px;
            color: rgba(255,255,255,0.3); z-index: 9999; pointer-events: none;
        }

        /* é¦–é åœ“å½¢é›·é” */
        .radar-circle {
            width: 120px; height: 120px;
            border-radius: 50%;
            border: 2px solid #06B6D4;
            box-shadow: 0 0 30px #06B6D4;
            display: flex; align-items: center; justify-content: center;
            background: rgba(6, 182, 212, 0.1);
            position: relative;
        }
        .radar-circle::after {
            content: ''; position: absolute; inset: -5px;
            border-radius: 50%; border: 1px solid rgba(6, 182, 212, 0.3);
            animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        /* ç»ç’ƒæ“¬æ…‹ */
        .glass-panel { 
            background: rgba(19, 27, 46, 0.6); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* --- éŠæˆ²ç‰¹æ•ˆ --- */
        
        /* æ‹”æ²³å…‰æŸ */
        .tug-beam-container {
            width: 90%; height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            position: relative;
            margin: 20px auto;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .tug-beam {
            position: absolute; top: 50%; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, #8B5CF6, #06B6D4, #8B5CF6);
            transform: translateY(-50%);
            box-shadow: 0 0 15px #06B6D4;
        }
        .tug-node {
            width: 40px; height: 40px;
            background: #fff;
            border-radius: 50%;
            position: absolute; top: 50%; left: 50%; /* JS control translateX */
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px #fff, 0 0 60px #06B6D4;
            z-index: 10;
            transition: left 0.3s ease-out;
        }
        .tug-zone {
            position: absolute; top: 0; bottom: 0; width: 2px;
            background: rgba(255,255,255,0.2);
        }
        
        /* ç–¾é€Ÿç ´å†° */
        @keyframes balloonFall {
            0% { top: -120px; opacity: 0; transform: scale(0.8); }
            10% { opacity: 1; transform: scale(1); }
            100% { top: 100vh; opacity: 1; }
        }
        .balloon-item {
            position: absolute; animation-name: balloonFall; animation-timing-function: linear;
            cursor: pointer; z-index: 50; transition: transform 0.1s; will-change: top;
        }
        
        /* è¨˜æ†¶é…å° */
        .perspective-1000 { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.5s; transform-style: preserve-3d; }
        .card-flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; inset: 0; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; }
        .card-front { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); }
        .card-back { background: #4c1d95; transform: rotateY(180deg); border: 1px solid #8B5CF6; }
    </style>
</head>
<body class="selection:bg-cyber-cyan selection:text-black">

    <div class="version-tag">Ver 3.0.0</div>
    <canvas id="bgCanvas" class="fixed top-0 left-0 w-full h-full -z-10 opacity-30"></canvas>

    <div id="app-container" class="max-w-md mx-auto min-h-screen relative flex flex-col z-10">
        
        <!-- HEADER -->
        <header id="app-header" class="hidden p-4 flex justify-between items-center glass-panel sticky top-0 z-50 rounded-b-2xl mb-4 border-b border-white/5">
            <div class="flex flex-col leading-none">
                <span class="text-[10px] text-cyber-cyan tracking-widest font-display">PPSH GALAXY</span>
                <span class="font-display font-bold text-lg text-white">BATTLE</span>
            </div>
            <div id="user-status" class="flex items-center gap-2">
                <div class="text-right">
                    <div class="text-[10px] text-gray-400">CREDITS</div>
                    <span id="header-score" class="text-cyber-cyan font-bold font-mono text-lg">0</span>
                </div>
                <img id="header-avatar" src="" class="w-10 h-10 rounded-full border-2 border-cyber-purple bg-black object-cover">
            </div>
        </header>

        <!-- VIEW 1: é¦–é  (ç¬¦åˆåœ– 1) -->
        <section id="view-login" class="flex-1 flex flex-col relative overflow-hidden justify-center px-6">
            
            <!-- Logo Area -->
            <div class="flex flex-col items-center mb-10">
                <div class="radar-circle mb-6">
                    <span class="text-4xl animate-bounce">ğŸš€</span>
                </div>
                <h1 class="text-center">
                    <span class="block text-3xl font-bold text-cyber-cyan mb-1 drop-shadow-[0_0_10px_rgba(6,182,212,0.8)]">å±åŒ—é«˜ä¸­</span>
                    <span class="block text-3xl font-bold text-white mb-2 drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">å–®å­—æ˜Ÿéš›çˆ­éœ¸</span>
                    <span class="block text-xs text-gray-400 tracking-[0.2em] font-display">PPSH VOCABULARY BATTLE</span>
                </h1>
            </div>

            <!-- Rank Cards -->
            <div class="grid grid-cols-2 gap-4 mb-10">
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center min-h-[120px] bg-cyber-card/80 border border-white/5">
                    <h3 class="text-cyber-cyan font-bold text-sm mb-2">æœ€å¼·å–®å­—ç‹</h3>
                    <div id="login-lb-user" class="text-xs text-gray-400">è®€å–ä¸­...</div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center min-h-[120px] bg-cyber-card/80 border border-white/5">
                    <h3 class="text-cyber-purple font-bold text-sm mb-2">æœ€å¼·æˆ°éšŠ</h3>
                    <div id="login-lb-team" class="text-xs text-gray-400">è®€å–ä¸­...</div>
                </div>
            </div>

            <!-- Login Button -->
            <button onclick="window.app.auth.login()" class="w-full py-4 rounded-xl bg-gradient-to-r from-blue-600 to-cyber-purple text-white font-bold text-lg shadow-[0_0_25px_rgba(139,92,246,0.4)] hover:scale-[1.02] transition-transform flex items-center justify-center gap-2">
                <i data-lucide="log-in" class="w-5 h-5"></i>
                ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>
            <p class="text-center text-[10px] text-gray-500 mt-4">åƒ…é™ @ppsh.ptc.edu.tw ç¶²åŸŸä½¿ç”¨</p>

        </section>

        <!-- VIEW 2: Dashboard -->
        <section id="view-dashboard" class="hidden flex-1 flex flex-col p-4 gap-6 pb-20">
            <!-- User Status -->
            <div class="glass-panel p-5 rounded-xl relative overflow-hidden">
                <div class="absolute -right-6 -top-6 w-32 h-32 bg-cyber-cyan/5 rounded-full blur-2xl"></div>
                <h2 id="dash-name" class="text-xl font-bold text-white relative z-10">è¼‰å…¥ä¸­...</h2>
                <p id="dash-team" class="text-xs text-gray-400 mt-1 relative z-10 font-mono">NO TEAM</p>
                <div class="mt-4 pt-4 border-t border-white/10 flex gap-2">
                    <button onclick="window.app.team.create()" class="flex-1 py-2 bg-cyber-cyan/10 border border-cyber-cyan/30 rounded text-xs text-cyber-cyan">å»ºç«‹éšŠä¼</button>
                    <button onclick="window.app.team.join()" class="flex-1 py-2 bg-cyber-purple/10 border border-cyber-purple/30 rounded text-xs text-cyber-purple">è¼¸å…¥ä»£ç¢¼</button>
                </div>
                <div id="team-info-box" class="hidden mt-3 p-2 bg-black/30 rounded text-xs text-center border border-white/5">
                    ä»£ç¢¼: <span id="team-code-display" class="font-mono text-white font-bold select-all cursor-pointer"></span>
                </div>
            </div>

            <!-- 1. å€‹äººæŒ‘æˆ°å€ (ç¬¦åˆåœ– 2) -->
            <div>
                <h3 class="text-base font-bold text-cyber-cyan mb-4 tracking-wider font-display">å€‹äººæŒ‘æˆ°å€ (SOLO)</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <!-- é…å°éŠæˆ² (ç¶ ) -->
                    <div onclick="window.app.game.setup('practice', 'match')" class="glass-panel p-4 rounded-xl border border-cyber-green/50 cursor-pointer hover:bg-cyber-green/10 transition-colors h-32 flex flex-col justify-center">
                        <i data-lucide="link" class="w-8 h-8 text-cyber-green mb-2"></i>
                        <h4 class="font-bold text-white">é…å°éŠæˆ²</h4>
                        <p class="text-xs text-gray-400">Match</p>
                    </div>
                    <!-- å‘½é‹è¼ªç›¤ (é»ƒ) -->
                    <div onclick="window.app.game.setup('practice', 'wheel')" class="glass-panel p-4 rounded-xl border border-cyber-yellow/50 cursor-pointer hover:bg-cyber-yellow/10 transition-colors h-32 flex flex-col justify-center">
                        <i data-lucide="aperture" class="w-8 h-8 text-cyber-yellow mb-2"></i>
                        <h4 class="font-bold text-white">å‘½é‹è¼ªç›¤</h4>
                        <p class="text-xs text-gray-400">Wheel</p>
                    </div>
                </div>
                <!-- è½éŸ³è¾¨ç¾© (è—) -->
                <div onclick="window.app.game.setup('practice', 'standard')" class="glass-panel p-4 rounded-xl border border-cyber-cyan/50 cursor-pointer hover:bg-cyber-cyan/10 transition-colors flex items-center gap-4">
                    <i data-lucide="headphones" class="w-8 h-8 text-cyber-cyan"></i>
                    <div>
                        <h4 class="font-bold text-white">è½éŸ³è¾¨ç¾© (æ¨™æº–)</h4>
                        <p class="text-xs text-gray-400">Audio Quiz</p>
                    </div>
                </div>
            </div>

            <!-- 2. åœ˜é«”ç«¶æŠ€å€ -->
            <div>
                <h3 class="text-base font-bold text-cyber-purple mb-4 tracking-wider font-display mt-2">åœ˜é«”ç«¶æŠ€å€ (TEAM)</h3>
                <div class="space-y-3">
                    <!-- å…‰é€Ÿæ‹”æ²³ (æ–°) -->
                    <div onclick="window.app.game.setup('ranked', 'tug')" class="glass-panel p-4 rounded-xl border-l-4 border-cyber-purple cursor-pointer hover:bg-white/5 flex justify-between items-center group">
                        <div>
                            <h4 class="font-bold text-cyber-purple group-hover:text-white transition-colors">ğŸš€ å…‰é€Ÿæ‹”æ²³ (Tug-of-War)</h4>
                            <p class="text-xs text-gray-400 mt-1">åœ˜éšŠå°æŠ— â€¢ æ‹‰åŠ›ç«¶è³½</p>
                        </div>
                        <i data-lucide="move-horizontal" class="text-cyber-purple"></i>
                    </div>

                    <div onclick="window.app.game.setup('ranked', 'speed')" class="glass-panel p-4 rounded-xl border-l-4 border-cyber-danger cursor-pointer hover:bg-white/5 flex justify-between items-center group">
                        <div>
                            <h4 class="font-bold text-cyber-danger group-hover:text-white transition-colors">ğŸˆ ç–¾é€Ÿç ´å†° (Speed Pop)</h4>
                            <p class="text-xs text-gray-400 mt-1">æ°£çƒæ‰è½ â€¢ æ¥µé™åæ‡‰</p>
                        </div>
                        <i data-lucide="zap" class="text-cyber-danger"></i>
                    </div>
                </div>
            </div>

            <button id="admin-btn" onclick="window.app.nav.to('admin')" class="hidden fixed bottom-4 right-4 p-3 bg-gray-800 rounded-full text-gray-400 hover:text-white shadow-lg border border-gray-700 z-50">
                <i data-lucide="settings" class="w-4 h-4"></i>
            </button>
        </section>

        <!-- VIEW 3: Setup -->
        <section id="view-setup" class="hidden flex-1 flex flex-col p-4 gap-6 justify-center">
            <h2 class="text-2xl font-display font-bold text-center text-white tracking-widest">MISSION CONFIG</h2>
            <div class="glass-panel p-6 rounded-2xl space-y-8">
                <div>
                    <label class="block text-xs text-gray-400 mb-2 uppercase">Target Sector</label>
                    <select id="setup-level" class="w-full bg-black/30 border border-gray-600 rounded p-3 text-sm text-white focus:border-cyber-cyan outline-none">
                        <option value="all">å…¨å®‡å®™ (All Levels)</option>
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5</option>
                        <option value="6">Level 6</option>
                    </select>
                </div>
                
                <div id="setup-count-group">
                    <label class="block text-xs text-gray-400 mb-4 uppercase flex justify-between">
                        <span>é¸æ“‡é¡Œæ•¸</span>
                        <span id="count-val" class="text-cyber-cyan font-bold font-mono text-lg">10</span>
                    </label>
                    <input type="range" id="setup-count" min="10" max="30" step="5" value="10" class="w-full accent-cyber-cyan h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('count-val').innerText = this.value">
                </div>

                <div class="space-y-3 pt-4">
                    <button onclick="window.app.game.start()" class="w-full py-4 bg-cyber-cyan text-black font-bold font-display tracking-widest rounded hover:bg-cyan-400 transition-colors shadow-[0_0_20px_rgba(6,182,212,0.3)]">INITIATE</button>
                    <button onclick="window.app.nav.to('dashboard')" class="w-full py-3 text-gray-500 text-xs tracking-widest hover:text-white">ABORT</button>
                </div>
            </div>
        </section>

        <!-- VIEW 4: Game Container -->
        <section id="view-game" class="hidden flex-1 flex flex-col relative overflow-hidden bg-black/60">
            <div class="absolute top-0 left-0 w-full p-4 z-30 flex justify-between items-start pointer-events-none">
                <button onclick="window.app.game.quit()" class="pointer-events-auto text-white/50 hover:text-white p-2 bg-black/30 rounded-full backdrop-blur-sm border border-white/10"><i data-lucide="x"></i></button>
                <div class="flex flex-col items-center">
                    <div id="game-mode-label" class="text-[10px] font-display text-cyber-cyan tracking-widest mb-1 shadow-black drop-shadow-md">MODE</div>
                    <div class="w-32 h-1.5 bg-gray-800 rounded-full overflow-hidden border border-white/10">
                        <div id="game-progress" class="h-full bg-gradient-to-r from-cyber-cyan to-blue-500 w-0 transition-all duration-300"></div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500">SCORE</div>
                    <div id="in-game-score" class="text-2xl font-display font-bold text-cyber-orange drop-shadow-md">0</div>
                </div>
            </div>

            <div id="game-stage" class="flex-1 w-full h-full relative flex flex-col items-center justify-center p-4 z-10"></div>
            <div id="danger-line" class="hidden absolute bottom-0 left-0 w-full h-4 bg-gradient-to-t from-red-600/50 to-transparent z-20 animate-pulse pointer-events-none border-b-2 border-red-500"></div>
        </section>

        <!-- VIEW 5: Result -->
        <section id="view-result" class="hidden flex-1 flex flex-col p-6 items-center justify-center gap-8 relative">
            <div class="text-center space-y-2 z-10">
                <h2 class="text-3xl font-display font-bold text-white neon-text">MISSION COMPLETE</h2>
                <div class="text-sm text-gray-400 tracking-widest">æœ¬æ¬¡æˆ°æœå ±å‘Š</div>
            </div>
            <div class="glass-panel w-full max-w-sm p-8 rounded-2xl text-center space-y-6 z-10 border-t-4 border-cyber-cyan">
                <div><div class="text-xs text-gray-500 uppercase tracking-widest mb-1">Total Score</div><div class="text-6xl font-display font-bold text-white drop-shadow-lg" id="res-score">0</div></div>
                <div id="res-stats" class="grid grid-cols-2 gap-4 text-xs"><div class="bg-white/5 p-3 rounded border border-white/5">æ­£ç¢ºç‡ <br> <span id="res-accuracy" class="text-cyber-cyan font-bold text-lg">100%</span></div><div class="bg-white/5 p-3 rounded border border-white/5">é€£æ“Š <br> <span id="res-streak" class="text-cyber-orange font-bold text-lg">0</span></div></div>
                <button id="btn-review-wrong" onclick="window.app.game.startWrongReview()" class="hidden w-full py-3 bg-red-900/20 border border-red-500/30 text-red-400 font-bold rounded flex items-center justify-center gap-2"><i data-lucide="flame" class="w-4 h-4"></i> ç‰¹è¨“éŒ¯é¡Œ (<span id="wrong-count">0</span>)</button>
                <div class="grid grid-cols-2 gap-3 pt-4 border-t border-white/10"><button onclick="window.app.nav.to('dashboard')" class="py-3 bg-gray-700/50 rounded font-bold text-sm hover:bg-gray-700">å›é¦–é </button><button onclick="window.app.game.setup(window.app.state.mode, window.app.state.gameType)" class="py-3 bg-cyber-purple text-white rounded font-bold text-sm hover:bg-purple-600 shadow-lg">å†ç©ä¸€æ¬¡</button></div>
            </div>
        </section>

        <!-- VIEW 7: Admin -->
        <section id="view-admin" class="hidden flex-1 flex flex-col p-4 gap-4">
            <h2 class="text-xl font-bold text-cyber-orange flex gap-2 items-center"><i data-lucide="shield-alert"></i> ADMIN CONSOLE</h2>
            <div class="glass-panel p-4 rounded-xl space-y-4">
                <div class="border border-dashed border-gray-600 p-4 rounded text-center"><input type="file" id="csv-upload" accept=".csv" class="block w-full text-xs text-gray-400 file:bg-cyber-purple file:text-white"/></div>
                <button onclick="window.app.admin.uploadCSV()" class="w-full py-2 bg-blue-600 rounded text-sm font-bold">Process Upload</button>
                <button onclick="window.app.admin.hardReset()" class="w-full py-3 bg-red-900/50 text-red-200 font-bold rounded text-sm border border-red-500">SYSTEM HARD RESET</button>
                <button onclick="window.app.nav.to('dashboard')" class="w-full py-2 bg-gray-700 rounded text-sm">Exit</button>
            </div>
        </section>
    </div>

    <!-- Alert Modal -->
    <div id="alert-box" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel p-6 rounded-xl max-w-xs w-full text-center border border-cyber-cyan/30 shadow-[0_0_50px_rgba(6,182,212,0.2)]">
            <h3 id="alert-title" class="text-lg font-bold mb-2 text-white font-display">Message</h3>
            <p id="alert-msg" class="text-gray-300 text-sm mb-6 leading-relaxed"></p>
            <button onclick="document.getElementById('alert-box').classList.add('hidden')" class="px-6 py-2 bg-cyber-cyan text-black font-bold rounded w-full hover:bg-cyan-400">ACKNOWLEDGED</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, query, where, getDocs, onSnapshot, limit, orderBy, increment, serverTimestamp, writeBatch, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQC4nD1ceknWbYq0DwY461XgPMSpzxzoE",
            authDomain: "ppsh-vocab-battle.firebaseapp.com",
            projectId: "ppsh-vocab-battle",
            storageBucket: "ppsh-vocab-battle.firebasestorage.app",
            messagingSenderId: "687928286974",
            appId: "1:687928286974:web:b79bd4476f63ce9d9bcfaf",
            measurementId: "G-675CNBRSZS"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const googleProvider = new GoogleAuthProvider();
        lucide.createIcons();

        // Cultural Icons
        const ICONS = {
            lily: `<svg viewBox="0 0 100 100" class="w-5 h-5 inline drop-shadow"><path d="M50 20 C60 5 80 20 50 50 C20 20 40 5 50 20 Z" fill="#fff"/><path d="M50 80 C40 95 20 80 50 50 C80 80 60 95 50 80 Z" fill="#fff"/><path d="M20 50 C5 40 20 20 50 50 C20 80 5 60 20 50 Z" fill="#fff"/><path d="M80 50 C95 60 80 80 50 50 C80 20 95 40 80 50 Z" fill="#fff"/><circle cx="50" cy="50" r="6" fill="#DC2626"/></svg>`,
            pot: `<svg viewBox="0 0 100 100" class="w-5 h-5 inline drop-shadow"><path d="M30 30 Q50 90 70 30 L60 20 L40 20 Z" fill="#5D4037"/><circle cx="50" cy="40" r="8" fill="none" stroke="#222" stroke-dasharray="2"/></svg>`,
            snake: `<svg viewBox="0 0 100 100" class="w-5 h-5 inline drop-shadow"><path d="M20 50 L35 30 L50 50 L65 30 L80 50 L65 70 L50 50 L35 70 Z" fill="#111" stroke="#fff" stroke-width="3"/></svg>`
        };

        const appLogic = {
            state: { 
                user: null, team: null, words: [], 
                quizList: [], wrongList: [], currentQIndex: 0, 
                score: 0, streak: 0, correctCount: 0,
                mode: 'practice', gameType: 'standard', 
                timer: null, tugPos: 50 // 0-100, 50 is center
            },
            
            init: () => {
                appLogic.ui.bgAnimation();
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        if (!user.email.endsWith("@ppsh.ptc.edu.tw")) { appLogic.ui.alert("å­˜å–è¢«æ‹’", "åƒ…é™ @ppsh.ptc.edu.tw ç¶²åŸŸ"); await signOut(auth); return; }
                        if (["fuwen@ppsh.ptc.edu.tw"].includes(user.email)) document.getElementById('admin-btn').classList.remove('hidden');
                        const userRef = doc(db, "users", user.uid); const userSnap = await getDoc(userRef);
                        if (!userSnap.exists()) await setDoc(userRef, { email: user.email, displayName: user.displayName, photoURL: user.photoURL, score: 0, weeklyScore: 0, teamId: null, lastPlayed: serverTimestamp() });
                        appLogic.state.user = { uid: user.uid, ...userSnap.data() || { score:0 } };
                        if (appLogic.state.user.teamId) appLogic.team.load(appLogic.state.user.teamId);
                        appLogic.ui.updateHeader(); appLogic.nav.to('dashboard');
                    } else {
                        appLogic.nav.to('login'); appLogic.leaderboard.renderPreview();
                    }
                });
            },
            auth: { login: () => signInWithPopup(auth, googleProvider).catch(e => appLogic.ui.alert("éŒ¯èª¤", e.message)) },

            game: {
                setup: async (mode, type) => {
                    appLogic.state.mode = mode;
                    appLogic.state.gameType = type;
                    if (mode === 'review') { appLogic.game.start(); return; }
                    if (appLogic.state.words.length === 0) {
                        const q = query(collection(db, "words"), limit(600)); const snapshot = await getDocs(q);
                        appLogic.state.words = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (appLogic.state.words.length === 0) { appLogic.ui.alert("ç³»çµ±", "ç„¡å–®å­—è³‡æ–™"); return; }
                    }
                    document.getElementById('setup-count-group').style.display = mode === 'ranked' ? 'none' : 'block';
                    appLogic.nav.to('setup');
                },

                start: () => {
                    appLogic.state.currentQIndex = 0; appLogic.state.score = 0;
                    appLogic.state.streak = 0; appLogic.state.correctCount = 0;
                    appLogic.state.tugPos = 50; // Reset tug
                    if (appLogic.state.timer) clearInterval(appLogic.state.timer);
                    
                    if (appLogic.state.mode !== 'review') {
                        appLogic.state.wrongList = [];
                        const level = document.getElementById('setup-level').value;
                        const countVal = appLogic.state.mode === 'ranked' ? 20 : parseInt(document.getElementById('setup-count').value);
                        let pool = appLogic.state.words.filter(w => {
                            if (level === 'all') return true;
                            if (level.includes('-')) { const [min, max] = level.split('-').map(Number); return parseInt(w.level) >= min && parseInt(w.level) <= max; }
                            return w.level === level;
                        });
                        if (pool.length < 5) pool = appLogic.state.words;
                        pool.sort(() => Math.random() - 0.5);
                        appLogic.state.quizList = pool.slice(0, countVal);
                    }

                    appLogic.nav.to('game');
                    document.getElementById('game-mode-label').innerText = appLogic.state.gameType.toUpperCase();
                    document.getElementById('in-game-score').innerText = "0";
                    document.getElementById('danger-line').classList.add('hidden');

                    if (appLogic.state.gameType === 'speed') appLogic.game.startSpeedGame();
                    else if (appLogic.state.gameType === 'tug') appLogic.game.startTugGame();
                    else if (appLogic.state.gameType === 'match') appLogic.game.startMatchGame();
                    else if (appLogic.state.gameType === 'wheel') appLogic.game.startWheelGame();
                    else appLogic.game.nextStandard(); 
                },

                quit: () => { gsap.killTweensOf("*"); appLogic.nav.to('dashboard'); },

                // --- 1. å…‰é€Ÿæ‹”æ²³ (Tug-of-War) ---
                startTugGame: () => {
                    const stage = document.getElementById('game-stage');
                    stage.innerHTML = `
                        <div class="w-full flex justify-between items-center mb-4 px-4">
                            <span class="text-cyber-cyan font-bold">TEAM</span>
                            <span class="text-red-500 font-bold">SYSTEM</span>
                        </div>
                        
                        <div class="tug-beam-container">
                            <div class="tug-beam"></div>
                            <div class="tug-zone" style="left: 50%"></div>
                            <div id="tug-node" class="tug-node" style="left: 50%"></div>
                        </div>
                        
                        <div id="tug-q-area" class="w-full flex flex-col items-center mt-8"></div>
                    `;
                    
                    // AI Pull Back Logic
                    appLogic.state.timer = setInterval(() => {
                        appLogic.state.tugPos = Math.min(100, appLogic.state.tugPos + 1); // AI pulls right
                        appLogic.game.updateTugUI();
                        if (appLogic.state.tugPos >= 95) appLogic.game.finishTug(false);
                    }, 800);

                    appLogic.game.nextTugQuestion();
                },

                updateTugUI: () => {
                    const node = document.getElementById('tug-node');
                    if(node) node.style.left = `${appLogic.state.tugPos}%`;
                },

                finishTug: (win) => {
                    if(appLogic.state.timer) clearInterval(appLogic.state.timer);
                    if(win) appLogic.state.score += 100;
                    appLogic.ui.alert(win ? "VICTORY" : "DEFEAT", win ? "å…‰æŸå¥ªå–æˆåŠŸï¼" : "è¢«ç³»çµ±æ‹‰èµ°äº†...");
                    setTimeout(appLogic.game.finish, 1500);
                },

                nextTugQuestion: () => {
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finishTug(true); return; }
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    appLogic.ui.updateGameProgress();

                    const area = document.getElementById('tug-q-area');
                    area.innerHTML = `
                        <div class="text-3xl font-bold text-white mb-6 animate-pulse">${q.word}</div>
                        <div class="grid grid-cols-2 gap-4 w-full max-w-md" id="tug-opts"></div>
                    `;
                    
                    let options = appLogic.game.getDistractors(q, 3);
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "py-6 bg-white/10 border border-white/20 rounded-xl text-lg font-bold hover:bg-cyber-cyan/30 hover:border-cyber-cyan transition-all";
                        btn.innerText = opt.chinese;
                        btn.onclick = () => {
                            if (opt.id === q.id) {
                                // Correct
                                let pull = 10;
                                if (appLogic.state.streak >= 4) { pull = 30; gsap.to("#app-container", {x:[-2,2,-2,2,0], duration:0.2}); } // Power Pull
                                appLogic.state.tugPos = Math.max(0, appLogic.state.tugPos - pull);
                                appLogic.game.updateTugUI();
                                appLogic.game.handleAnswer(true);
                                
                                if (appLogic.state.tugPos <= 5) appLogic.game.finishTug(true);
                                else {
                                    appLogic.state.currentQIndex++;
                                    appLogic.game.nextTugQuestion();
                                }
                            } else {
                                appLogic.state.tugPos += 10; // Penalty
                                appLogic.game.updateTugUI();
                                appLogic.game.handleAnswer(false);
                            }
                        };
                        document.getElementById('tug-opts').appendChild(btn);
                    });
                },

                // --- 2. ç–¾é€Ÿç ´å†° (Speed Pop) ---
                startSpeedGame: () => {
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finish(); return; }
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    appLogic.ui.updateGameProgress();
                    const stage = document.getElementById('game-stage');
                    document.getElementById('danger-line').classList.remove('hidden');
                    
                    stage.innerHTML = `
                        <div class="z-0 pointer-events-none flex flex-col items-center animate-pulse-slow">
                            <div class="text-4xl md:text-6xl font-display font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500 drop-shadow-2xl text-center">${q.word}</div>
                            <div class="text-xs text-cyber-cyan mt-2 tracking-[0.5em] opacity-70">${q.type || 'VOCAB'}</div>
                        </div>
                        <div id="balloon-container" class="absolute inset-0 w-full h-full overflow-hidden"></div>
                    `;

                    let options = appLogic.game.getDistractors(q, 2); options.sort(() => Math.random() - 0.5);
                    const container = document.getElementById('balloon-container');

                    options.forEach((opt, i) => {
                        const balloon = document.createElement('div');
                        balloon.className = "balloon-item absolute p-4 w-24 h-24 rounded-full flex items-center justify-center text-center text-sm font-bold shadow-[0_0_20px_rgba(255,255,255,0.2)] border border-white/20 backdrop-blur-md";
                        if (i === 0) balloon.classList.add('bg-cyber-purple/80', 'text-white');
                        else if (i === 1) balloon.classList.add('bg-blue-600/80', 'text-white');
                        else balloon.classList.add('bg-cyber-cyan/80', 'text-black');
                        balloon.innerText = opt.chinese;
                        
                        balloon.style.left = `${10 + Math.random() * 70}%`;
                        balloon.style.animationDelay = `${i * 0.8}s`;
                        balloon.style.animationDuration = `${Math.max(3, 6 - (appLogic.state.currentQIndex * 0.15))}s`;

                        balloon.onmousedown = () => {
                            balloon.remove();
                            if (opt.id === q.id) { appLogic.game.handleAnswer(true); container.innerHTML = ''; setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.startSpeedGame(); }, 300); }
                            else { appLogic.game.handleAnswer(false); }
                        };
                        balloon.addEventListener('animationend', () => {
                            balloon.remove();
                            if (opt.id === q.id) { appLogic.game.handleAnswer(false); appLogic.ui.alert("MISS!", `ç­”æ¡ˆï¼š${q.chinese}`); setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.startSpeedGame(); }, 1000); }
                        });
                        container.appendChild(balloon);
                    });
                },

                // --- 3. Match Game ---
                startMatchGame: () => {
                    const stage = document.getElementById('game-stage');
                    const batch = appLogic.state.quizList.slice(0, 5); 
                    if(batch.length === 0) { appLogic.game.finish(); return; }
                    let left = [...batch].sort(()=>Math.random()-0.5), right = [...batch].sort(()=>Math.random()-0.5);
                    let sel = null, matched = 0;
                    stage.innerHTML = `<div class="grid grid-cols-2 gap-4 w-full h-full content-center" id="match-grid"></div>`;
                    const render = () => {
                        const g = document.getElementById('match-grid'); g.innerHTML='';
                        left.forEach(w=>{ if(!w.done) g.innerHTML+=`<button data-id="${w.id}" data-side="L" class="p-4 bg-cyber-green/20 border border-cyber-green/50 rounded text-sm">${w.word}</button>`});
                        right.forEach(w=>{ if(!w.done) g.innerHTML+=`<button data-id="${w.id}" data-side="R" class="p-4 bg-cyber-purple/20 border border-cyber-purple/50 rounded text-sm">${w.chinese}</button>`});
                        g.querySelectorAll('button').forEach(b=>{
                            b.onclick=()=>{
                                if(!sel) { sel={id:b.dataset.id, el:b}; b.classList.add('bg-white/20'); }
                                else {
                                    if(sel.id===b.dataset.id && sel.el!==b) { appLogic.game.handleAnswer(true); left.find(i=>i.id==sel.id).done=true; right.find(i=>i.id==sel.id).done=true; matched++; if(matched===batch.length) appLogic.game.finish(); else render(); sel=null; }
                                    else { sel.el.classList.remove('bg-white/20'); sel=null; appLogic.game.handleAnswer(false); }
                                }
                            }
                        });
                    }; render();
                },

                // --- 4. Wheel Game ---
                startWheelGame: () => {
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    const stage = document.getElementById('game-stage');
                    stage.innerHTML = `<div class="relative w-64 h-64 mb-8"><div id="wheel" class="w-full h-full rounded-full border-4 border-cyber-yellow flex items-center justify-center bg-black shadow-[0_0_30px_#FACC15]"><span class="text-4xl">â“</span></div></div><button id="spin-btn" class="px-8 py-3 bg-cyber-yellow text-black rounded-full font-bold animate-pulse">SPIN</button><div id="wheel-q" class="hidden glass-panel p-4 rounded-xl w-full text-center mt-4"></div>`;
                    document.getElementById('spin-btn').onclick = () => {
                        const wheel = document.getElementById('wheel');
                        wheel.style.transition = "transform 3s cubic-bezier(0.1,0,0.2,1)"; wheel.style.transform = `rotate(${720+Math.random()*360}deg)`;
                        setTimeout(()=>{
                            wheel.innerHTML = `<span class="text-xl font-bold text-cyber-yellow">${q.word}</span>`;
                            const qDiv = document.getElementById('wheel-q'); qDiv.classList.remove('hidden'); qDiv.innerHTML='';
                            let opts = appLogic.game.getDistractors(q,3);
                            opts.forEach(c=>{ qDiv.innerHTML+=`<button onclick="window.app.game.checkStandard('${c.id===q.id}')" class="block w-full py-3 mb-2 bg-white/5 border border-white/10 rounded">${c.chinese}</button>`; });
                        },3000);
                    };
                },

                // --- Standard / Review ---
                nextStandard: () => {
                    if (appLogic.state.currentQIndex >= appLogic.state.quizList.length) { appLogic.game.finish(); return; }
                    const q = appLogic.state.quizList[appLogic.state.currentQIndex];
                    appLogic.ui.updateGameProgress();
                    const stage = document.getElementById('game-stage');
                    document.getElementById('danger-line').classList.add('hidden');

                    stage.innerHTML = `
                        <div class="glass-panel w-full max-w-sm p-6 rounded-2xl flex flex-col items-center text-center">
                            <div class="w-full flex justify-between items-center mb-6 border-b border-white/10 pb-2">
                                <span class="text-xs text-gray-500 font-mono">${q.level ? 'LEVEL '+q.level : 'LEVEL 1'}</span>
                                <span class="text-xs text-cyber-cyan font-mono tracking-widest">${q.type || 'N.'}</span>
                            </div>
                            <button onclick="window.app.game.speak('${q.word.replace(/'/g, "\\'")}')" class="w-20 h-20 rounded-full bg-cyber-cyan/10 border border-cyber-cyan text-cyber-cyan flex items-center justify-center hover:bg-cyber-cyan/20 transition-all mb-4 animate-pulse-slow"><i data-lucide="volume-2" class="w-8 h-8"></i></button>
                            <div class="text-xs text-gray-500 mb-6 tracking-wider">é»æ“Šç™¼éŸ³</div>
                            <div class="grid w-full gap-3" id="std-options"></div>
                        </div>
                    `;
                    lucide.createIcons();
                    appLogic.game.speak(q.word);

                    const optContainer = document.getElementById('std-options');
                    let options = appLogic.game.getDistractors(q, 3);
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "w-full py-4 bg-white/5 border border-white/10 rounded-xl hover:border-cyber-cyan hover:bg-white/10 transition-all font-bold text-gray-200 text-lg relative overflow-hidden active:scale-95";
                        btn.innerText = opt.chinese;
                        btn.onclick = () => {
                            if (opt.id === q.id) {
                                btn.classList.add('bg-green-500/20', 'border-green-500');
                                appLogic.game.handleAnswer(true);
                                setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.nextStandard(); }, 600);
                            } else {
                                btn.classList.add('bg-red-500/20', 'border-red-500');
                                appLogic.game.handleAnswer(false);
                                appLogic.ui.alert("WRONG", `æ­£ç¢ºç­”æ¡ˆ: ${q.chinese}`);
                                setTimeout(() => { appLogic.state.currentQIndex++; appLogic.game.nextStandard(); }, 1500);
                            }
                        };
                        optContainer.appendChild(btn);
                    });
                },
                checkStandard: (isCorrectStr) => { /* Helper for Wheel */
                    if(isCorrectStr==='true') { appLogic.game.handleAnswer(true); setTimeout(()=>{ appLogic.state.currentQIndex++; appLogic.game.startWheelGame(); },1000); }
                    else { appLogic.game.handleAnswer(false); setTimeout(()=>{ appLogic.state.currentQIndex++; appLogic.game.startWheelGame(); },1000); }
                },

                // --- Core Logic ---
                handleAnswer: (isCorrect) => {
                    const currentQ = appLogic.state.quizList[appLogic.state.currentQIndex];
                    if (isCorrect) {
                        appLogic.state.score += 10 + (appLogic.state.streak * 2);
                        appLogic.state.streak++; appLogic.state.correctCount++;
                        if (appLogic.state.streak === 5) appLogic.ui.triggerNeonFrenzy();
                        document.getElementById('in-game-score').innerText = appLogic.state.score;
                        confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 }, colors: ['#06B6D4', '#8B5CF6'] });
                    } else {
                        appLogic.state.streak = 0;
                        if (currentQ && !appLogic.state.wrongList.find(w => w.id === currentQ.id)) appLogic.state.wrongList.push(currentQ);
                        gsap.to("#app-container", { x: [-5, 5, -5, 5, 0], duration: 0.3 });
                    }
                },
                getDistractors: (correct, count) => {
                    let choices = [correct]; let pool = appLogic.state.words; let safety = 0;
                    while (choices.length < count + 1 && safety < 50) {
                        let rnd = pool[Math.floor(Math.random() * pool.length)];
                        if (!choices.find(c => c.id === rnd.id)) choices.push(rnd);
                        safety++;
                    }
                    return choices.sort(() => Math.random() - 0.5);
                },
                speak: (txt) => { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(txt); u.lang = 'en-US'; window.speechSynthesis.speak(u); },
                
                finish: async () => {
                    if(appLogic.state.timer) clearInterval(appLogic.state.timer);
                    document.getElementById('res-score').innerText = appLogic.state.score;
                    document.getElementById('res-accuracy').innerText = (Math.round((appLogic.state.correctCount / appLogic.state.quizList.length) * 100) || 0) + "%";
                    document.getElementById('res-streak').innerText = appLogic.state.streak;
                    
                    const reviewBtn = document.getElementById('btn-review-wrong');
                    if (appLogic.state.wrongList.length > 0) {
                        reviewBtn.classList.remove('hidden'); document.getElementById('wrong-count').innerText = appLogic.state.wrongList.length;
                    } else { reviewBtn.classList.add('hidden'); }

                    if (appLogic.state.mode === 'ranked') {
                        try {
                            const userRef = doc(db, "users", appLogic.state.user.uid);
                            await updateDoc(userRef, { score: increment(appLogic.state.score), weeklyScore: increment(appLogic.state.score), lastPlayed: serverTimestamp() });
                            if (appLogic.state.user.teamId) await updateDoc(doc(db, "teams", appLogic.state.user.teamId), { score: increment(appLogic.state.score) });
                            appLogic.state.user.score += appLogic.state.score; appLogic.ui.updateHeader();
                        } catch(e) { console.error(e); }
                    }
                    appLogic.nav.to('result');
                },
                startWrongReview: () => {
                    appLogic.state.quizList = [...appLogic.state.wrongList];
                    appLogic.state.mode = 'review'; appLogic.state.gameType = 'standard';
                    appLogic.game.start();
                }
            },

            ui: {
                startTicker: () => { /* ... */ },
                updateGameProgress: () => { document.getElementById('game-progress').style.width = `${(appLogic.state.currentQIndex / appLogic.state.quizList.length) * 100}%`; },
                updateHeader: () => { document.getElementById('header-avatar').src = appLogic.state.user.photoURL; document.getElementById('header-score').innerText = appLogic.state.user.score; document.getElementById('app-header').classList.remove('hidden'); document.getElementById('dash-name').innerText = appLogic.state.user.displayName; },
                alert: (t, m) => { document.getElementById('alert-title').innerText=t; document.getElementById('alert-msg').innerText=m; document.getElementById('alert-box').classList.remove('hidden'); },
                triggerNeonFrenzy: () => { const layer = document.getElementById('frenzy-layer'); layer.classList.add('neon-frenzy-bg', 'opacity-100'); setTimeout(() => { layer.classList.remove('opacity-100'); setTimeout(() => layer.classList.remove('neon-frenzy-bg'), 1000); }, 2000); },
                bgAnimation: () => { /* Particle Code */ }
            },
            team: {
                create: async () => { /* Same */ }, join: async () => { /* Same */ }, load: (tid) => { /* Same */ }
            },
            admin: {
                uploadCSV: () => { /* Same */ }, hardReset: async () => { /* Same */ }
            },
            leaderboard: {
                renderPreview: async () => {
                    const uQ = query(collection(db, "users"), orderBy("score", "desc"), limit(3)); const uSnap = await getDocs(uQ);
                    document.getElementById('login-lb-user').innerHTML = uSnap.docs.map((d,i)=>`<div class="flex justify-between w-full mb-1 border-b border-white/5 pb-1"><span class="text-xs text-white">${i+1}. ${d.data().displayName}</span><span class="text-cyber-cyan">${d.data().score}</span></div>`).join('');
                    const tQ = query(collection(db, "teams"), orderBy("score", "desc"), limit(3)); const tSnap = await getDocs(tQ);
                    document.getElementById('login-lb-team').innerHTML = tSnap.docs.map((d,i)=>`<div class="flex justify-between w-full mb-1 border-b border-white/5 pb-1"><span class="text-xs text-white">${i+1}. ${d.data().name}</span><span class="text-cyber-purple">${d.data().score}</span></div>`).join('');
                },
                show: () => { appLogic.nav.to('leaderboard'); appLogic.leaderboard.fetchData(); },
                switchSubTab: (subTab) => { /* ... */ },
                fetchData: async () => { /* ... */ }
            },
            nav: { to: (id) => { document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById('view-'+id).classList.remove('hidden'); if(id==='login') document.getElementById('app-header').classList.add('hidden'); else document.getElementById('app-header').classList.remove('hidden'); }}
        };

        window.app = appLogic;
        window.addEventListener('DOMContentLoaded', appLogic.init);
    </script>
</body>
</html>